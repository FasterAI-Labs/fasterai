---

title: Knowledge Distillation


keywords: fastai
sidebar: home_sidebar

summary: "How to apply knowledge distillation with fasterai"
description: "How to apply knowledge distillation with fasterai"
nb_path: "nbs/04b_tutorial.knowledge_distillation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04b_tutorial.knowledge_distillation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll illustrate how to use Knowledge Distillation to distill the knowledge of a Resnet34 (the teacher), to a Resnet18 (the student)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's us grab some data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s2">&quot;images&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_name_func</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">label_func</span><span class="p">,</span> <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first step is then to train the teacher model. We'll start from a pretrained model, ensuring to get good results on our dataset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">teacher</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">teacher</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">teacher</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/HubensN/miniconda3/envs/deep/lib/python3.8/site-packages/fastai/vision/learner.py:265: UserWarning: `cnn_learner` has been renamed to `vision_learner` -- please update your code
  warn(&#34;`cnn_learner` has been renamed to `vision_learner` -- please update your code&#34;)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.738216</td>
      <td>0.514556</td>
      <td>0.847091</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.491984</td>
      <td>0.307432</td>
      <td>0.863329</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.447923</td>
      <td>1.710455</td>
      <td>0.701624</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.452576</td>
      <td>0.340987</td>
      <td>0.844384</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.287033</td>
      <td>0.239666</td>
      <td>0.893099</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.238854</td>
      <td>0.230530</td>
      <td>0.909337</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.144284</td>
      <td>0.175067</td>
      <td>0.927605</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.098495</td>
      <td>0.161163</td>
      <td>0.930988</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.050567</td>
      <td>0.149135</td>
      <td>0.942490</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.032685</td>
      <td>0.151816</td>
      <td>0.941137</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Without-KD">Without KD<a class="anchor-link" href="#Without-KD"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll now train a Resnet18 from scratch, and without any help from the teacher model, to get that as a baseline</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">student</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">student</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.592990</td>
      <td>0.880996</td>
      <td>0.677943</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.568779</td>
      <td>0.633168</td>
      <td>0.636671</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.533047</td>
      <td>0.738055</td>
      <td>0.539242</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.486673</td>
      <td>0.749287</td>
      <td>0.717185</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.438561</td>
      <td>0.451227</td>
      <td>0.784844</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.395264</td>
      <td>0.384985</td>
      <td>0.828146</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.339680</td>
      <td>0.372352</td>
      <td>0.845061</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.264073</td>
      <td>0.353506</td>
      <td>0.842355</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.194599</td>
      <td>0.351618</td>
      <td>0.857239</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.158134</td>
      <td>0.342614</td>
      <td>0.853857</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="With-KD">With KD<a class="anchor-link" href="#With-KD"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now we train the same model, but with the help of the teacher. The chosen loss is a combination of the regular classification loss (Cross-Entropy) and a loss pushing the student to learn from the teacher's predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">student</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">kd</span> <span class="o">=</span> <span class="n">KnowledgeDistillationCallback</span><span class="p">(</span><span class="n">teacher</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">SoftTarget</span><span class="p">)</span>
<span class="n">student</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">kd</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.296719</td>
      <td>1.884460</td>
      <td>0.711773</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2.191021</td>
      <td>1.805818</td>
      <td>0.729364</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.973543</td>
      <td>1.675716</td>
      <td>0.752368</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.770022</td>
      <td>1.516037</td>
      <td>0.769283</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.556814</td>
      <td>1.472682</td>
      <td>0.790257</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1.290988</td>
      <td>1.036582</td>
      <td>0.841001</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1.036041</td>
      <td>0.882328</td>
      <td>0.857239</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.809941</td>
      <td>0.858502</td>
      <td>0.852503</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.608483</td>
      <td>0.804021</td>
      <td>0.863329</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.481355</td>
      <td>0.793109</td>
      <td>0.864005</td>
      <td>00:12</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When helped, the student model performs better !</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There exist more complicated KD losses, such as the one coming from <code>Paying Attention to Attention</code>, where the student tries to replicate the same attention maps of the teacher at intermediate layers.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Using such a loss requires to be able to specify from which layer we want to replicate those attention maps. To do so, we have to specify them from their <code>string</code> name, which can be obtained with the <a href="/fasterai/knowledge_distillation.html#get_model_layers"><code>get_model_layers</code></a> function.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, we set the loss to be applied after each Residual block of our models:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">student</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">kd</span> <span class="o">=</span> <span class="n">KnowledgeDistillationCallback</span><span class="p">(</span><span class="n">teacher</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">Attention</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;layer1&#39;</span><span class="p">,</span> <span class="s1">&#39;layer2&#39;</span><span class="p">,</span> <span class="s1">&#39;layer3&#39;</span><span class="p">,</span> <span class="s1">&#39;layer4&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;0.4&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="s1">&#39;0.6&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">student</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">kd</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.091224</td>
      <td>0.094667</td>
      <td>0.686739</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.083294</td>
      <td>0.079744</td>
      <td>0.701624</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.069417</td>
      <td>0.064017</td>
      <td>0.788904</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.061072</td>
      <td>0.062791</td>
      <td>0.787551</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.054276</td>
      <td>0.053314</td>
      <td>0.843708</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.048175</td>
      <td>0.050120</td>
      <td>0.826793</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.040943</td>
      <td>0.051322</td>
      <td>0.849120</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.031932</td>
      <td>0.048541</td>
      <td>0.855210</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.024598</td>
      <td>0.043699</td>
      <td>0.881597</td>
      <td>00:13</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.021455</td>
      <td>0.043395</td>
      <td>0.879567</td>
      <td>00:12</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

