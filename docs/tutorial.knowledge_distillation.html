---

title: Knowledge Distillation


keywords: fastai
sidebar: home_sidebar

summary: "How to apply knowledge distillation with fasterai"
description: "How to apply knowledge distillation with fasterai"
nb_path: "nbs/04b_tutorial.knowledge_distillation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04b_tutorial.knowledge_distillation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll illustrate how to use Knowledge Distillation to distill the knowledge of a Resnet34 (the teacher), to a Resnet18 (the student)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's us grab some data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s2">&quot;images&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_name_func</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">label_func</span><span class="p">,</span> <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first step is then to train the teacher model. We'll start from a pretrained model, ensuring to get good results on our dataset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">teacher</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">teacher</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">teacher</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/HubensN/miniconda3/envs/deep/lib/python3.8/site-packages/fastai/vision/learner.py:265: UserWarning: `cnn_learner` has been renamed to `vision_learner` -- please update your code
  warn(&#34;`cnn_learner` has been renamed to `vision_learner` -- please update your code&#34;)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.721918</td>
      <td>0.643276</td>
      <td>0.841678</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.484658</td>
      <td>0.604135</td>
      <td>0.828146</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.401239</td>
      <td>1.103915</td>
      <td>0.815291</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.394400</td>
      <td>0.318618</td>
      <td>0.860622</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.276733</td>
      <td>0.276223</td>
      <td>0.878890</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.187687</td>
      <td>0.515996</td>
      <td>0.851150</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.127520</td>
      <td>0.230542</td>
      <td>0.911367</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.071110</td>
      <td>0.233229</td>
      <td>0.924222</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.044975</td>
      <td>0.199706</td>
      <td>0.931664</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.031355</td>
      <td>0.177644</td>
      <td>0.939784</td>
      <td>00:08</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Without-KD">Without KD<a class="anchor-link" href="#Without-KD"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll now train a Resnet18 from scratch, and without any help from the teacher model, to get that as a baseline</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">student</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">student</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.608119</td>
      <td>0.594279</td>
      <td>0.679296</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.577984</td>
      <td>0.637746</td>
      <td>0.690798</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.543163</td>
      <td>0.532345</td>
      <td>0.732070</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.508363</td>
      <td>0.468151</td>
      <td>0.772666</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.464459</td>
      <td>0.442890</td>
      <td>0.780108</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.405926</td>
      <td>0.410481</td>
      <td>0.816644</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.355392</td>
      <td>0.429471</td>
      <td>0.821380</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.278941</td>
      <td>0.365873</td>
      <td>0.838972</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.218126</td>
      <td>0.366222</td>
      <td>0.855886</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.165694</td>
      <td>0.367872</td>
      <td>0.857239</td>
      <td>00:07</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="With-KD">With KD<a class="anchor-link" href="#With-KD"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now we train the same model, but with the help of the teacher. The chosen loss is a combination of the regular classification loss (Cross-Entropy) and a loss pushing the student to learn from the teacher's predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">student</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">kd</span> <span class="o">=</span> <span class="n">KnowledgeDistillationCallback</span><span class="p">(</span><span class="n">teacher</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">SoftTarget</span><span class="p">)</span>
<span class="n">student</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">kd</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.335700</td>
      <td>1.860445</td>
      <td>0.692828</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2.241398</td>
      <td>1.773348</td>
      <td>0.727334</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2.055018</td>
      <td>1.710084</td>
      <td>0.723951</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.851421</td>
      <td>1.632465</td>
      <td>0.761840</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.620585</td>
      <td>1.675239</td>
      <td>0.755751</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1.393245</td>
      <td>1.410955</td>
      <td>0.774019</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1.155736</td>
      <td>1.087842</td>
      <td>0.826116</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.908853</td>
      <td>0.983743</td>
      <td>0.838972</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.696537</td>
      <td>0.852848</td>
      <td>0.857916</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.564625</td>
      <td>0.854901</td>
      <td>0.857239</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When helped, the student model performs better !</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There exist more complicated KD losses, such as the one coming from <code>Paying Attention to Attention</code>, where the student tries to replicate the same attention maps of the teacher at intermediate layers.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Using such a loss requires to be able to specify from which layer we want to replicate those attention maps. To do so, we have to specify them from their <code>string</code> name, which can be obtained with the <a href="/fasterai/knowledge_distillation.html#get_model_layers"><code>get_model_layers</code></a> function.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, we set the loss to be applied after each Residual block of our models:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">student</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">kd</span> <span class="o">=</span> <span class="n">KnowledgeDistillationCallback</span><span class="p">(</span><span class="n">teacher</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">Attention</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;layer1&#39;</span><span class="p">,</span> <span class="s1">&#39;layer2&#39;</span><span class="p">,</span> <span class="s1">&#39;layer3&#39;</span><span class="p">,</span> <span class="s1">&#39;layer4&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;0.4&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="s1">&#39;0.6&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">student</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">kd</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.088313</td>
      <td>0.088667</td>
      <td>0.679973</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.079737</td>
      <td>0.077369</td>
      <td>0.719892</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.070380</td>
      <td>0.065641</td>
      <td>0.765223</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.061056</td>
      <td>0.061554</td>
      <td>0.792963</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.055300</td>
      <td>0.058515</td>
      <td>0.790934</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.048522</td>
      <td>0.052656</td>
      <td>0.830853</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.040360</td>
      <td>0.047567</td>
      <td>0.847767</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.032288</td>
      <td>0.046334</td>
      <td>0.855210</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.023988</td>
      <td>0.045383</td>
      <td>0.868065</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.020456</td>
      <td>0.044370</td>
      <td>0.866712</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

