---

title: SparsifyCallback


keywords: fastai
sidebar: home_sidebar

summary: "Use the sparsifier in fastai Callback system"
description: "Use the sparsifier in fastai Callback system"
nb_path: "nbs/02_sparsify_callback-Copy1.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_sparsify_callback-Copy1.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s2">&quot;images&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_name_func</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">label_func</span><span class="p">,</span> <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SparsifyCallback" class="doc_header"><code>class</code> <code>SparsifyCallback</code><a href="https://github.com/nathanhubens/fasterai/tree/master/fasterai/sparse/sparsify_callback.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SparsifyCallback</code>(<strong><code>sparsity</code></strong>, <strong><code>granularity</code></strong>, <strong><code>context</code></strong>, <strong><code>criteria</code></strong>, <strong><code>schedule</code></strong>, <strong><code>lth</code></strong>=<em><code>False</code></em>, <strong><code>rewind_epoch</code></strong>=<em><code>0</code></em>, <strong><code>reset_end</code></strong>=<em><code>False</code></em>, <strong><code>save_tickets</code></strong>=<em><code>False</code></em>, <strong><code>model</code></strong>=<em><code>None</code></em>, <strong><code>round_to</code></strong>=<em><code>None</code></em>, <strong><code>layer_type</code></strong>=<em><code>Conv2d</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The most important part of our <code>Callback</code> happens in <code>before_batch</code>. There, we first compute the sparsity of our network according to our schedule and then we remove the parameters accordingly.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/HubensN/miniconda3/envs/deep/lib/python3.8/site-packages/fastai/vision/learner.py:265: UserWarning: `cnn_learner` has been renamed to `vision_learner` -- please update your code
  warn(&#34;`cnn_learner` has been renamed to `vision_learner` -- please update your code&#34;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.656014</td>
      <td>0.538887</td>
      <td>0.855210</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.376843</td>
      <td>0.244617</td>
      <td>0.893099</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.228075</td>
      <td>0.310431</td>
      <td>0.890392</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.136198</td>
      <td>0.161978</td>
      <td>0.942490</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.069074</td>
      <td>0.166980</td>
      <td>0.941813</td>
      <td>00:07</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's now try adding some sparsity in our model</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/HubensN/miniconda3/envs/deep/lib/python3.8/site-packages/fastai/vision/learner.py:265: UserWarning: `cnn_learner` has been renamed to `vision_learner` -- please update your code
  warn(&#34;`cnn_learner` has been renamed to `vision_learner` -- please update your code&#34;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/fasterai/sparsify_callback.html#SparsifyCallback"><code>SparsifyCallback</code></a> requires a new argument compared to the <a href="/fasterai/sparsifier.html#Sparsifier"><code>Sparsifier</code></a>. Indeed, we need to know the pruning schedule that we should follow during training in order to prune the parameters accordingly.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can use any scheduling function already <a href="https://docs.fast.ai/callback.schedule.html#Annealing">available</a> in fastai or come up with your own ! For more information about the pruning schedules, take a look at the <a href="https://nathanhubens.github.io/fasterai/schedules.html">Schedules section</a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">updating_movmag</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of weight until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.575592</td>
      <td>0.496558</td>
      <td>0.853857</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.365092</td>
      <td>0.276531</td>
      <td>0.887010</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.268107</td>
      <td>0.255463</td>
      <td>0.891746</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.219608</td>
      <td>0.464234</td>
      <td>0.833559</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.185735</td>
      <td>0.245078</td>
      <td>0.893099</td>
      <td>00:08</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [4.77]%
Sparsity at the end of epoch 1: [17.27]%
Sparsity at the end of epoch 2: [32.73]%
Sparsity at the end of epoch 3: [45.23]%
Sparsity at the end of epoch 4: [50.0]%
Final Sparsity: [50.0]%
Sparsity in Conv2d 2: 50.00%
Sparsity in Conv2d 8: 50.00%
Sparsity in Conv2d 11: 50.00%
Sparsity in Conv2d 14: 50.00%
Sparsity in Conv2d 17: 50.00%
Sparsity in Conv2d 21: 50.00%
Sparsity in Conv2d 24: 50.00%
Sparsity in Conv2d 27: 50.00%
Sparsity in Conv2d 30: 50.00%
Sparsity in Conv2d 33: 50.00%
Sparsity in Conv2d 37: 50.00%
Sparsity in Conv2d 40: 50.00%
Sparsity in Conv2d 43: 50.00%
Sparsity in Conv2d 46: 50.00%
Sparsity in Conv2d 49: 50.00%
Sparsity in Conv2d 53: 50.00%
Sparsity in Conv2d 56: 50.00%
Sparsity in Conv2d 59: 50.00%
Sparsity in Conv2d 62: 50.00%
Sparsity in Conv2d 65: 50.00%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">zrs</span><span class="p">,</span> <span class="n">els</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
            <span class="n">zrs</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">els</span> <span class="o">+=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#wf = self.f(m.weight[None].mean(dim=dim, keepdim=True)).squeeze(0)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#if self.needs_update: wi = self.f(m._old_weights[None].mean(dim=dim, keepdim=True)).squeeze(0)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fasterai.sparse.granularity</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">random</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">)</span>
<span class="n">large_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span>
<span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.5009)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">random</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;weight&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor(0.4979)
tensor(0.4964)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.4964)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">downsample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.0240, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.0372, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">downsample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.0240, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.0076, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">large_final</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(11.1946, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">large_final</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">downsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(2.8424, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">large_final</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(64.6641, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">large_final</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of filter until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.588333</td>
      <td>0.340610</td>
      <td>0.855210</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.382023</td>
      <td>0.308627</td>
      <td>0.871448</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.273823</td>
      <td>0.317229</td>
      <td>0.869418</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.209344</td>
      <td>0.227701</td>
      <td>0.899865</td>
      <td>00:07</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.184172</td>
      <td>0.265235</td>
      <td>0.901894</td>
      <td>00:07</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [4.77]%
Sparsity at the end of epoch 1: [17.27]%
Sparsity at the end of epoch 2: [32.73]%
Sparsity at the end of epoch 3: [45.23]%
Sparsity at the end of epoch 4: [50.0]%
Final Sparsity: [50.0]%
Sparsity in Conv2d 2: 12.50%
Sparsity in Conv2d 8: 0.00%
Sparsity in Conv2d 11: 0.00%
Sparsity in Conv2d 14: 0.00%
Sparsity in Conv2d 17: 0.00%
Sparsity in Conv2d 21: 0.00%
Sparsity in Conv2d 24: 0.00%
Sparsity in Conv2d 27: 0.78%
Sparsity in Conv2d 30: 0.00%
Sparsity in Conv2d 33: 1.56%
Sparsity in Conv2d 37: 0.00%
Sparsity in Conv2d 40: 2.34%
Sparsity in Conv2d 43: 3.12%
Sparsity in Conv2d 46: 54.69%
Sparsity in Conv2d 49: 66.80%
Sparsity in Conv2d 53: 99.61%
Sparsity in Conv2d 56: 99.80%
Sparsity in Conv2d 59: 3.32%
Sparsity in Conv2d 62: 99.80%
Sparsity in Conv2d 65: 99.80%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of filter until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.778744</td>
      <td>1.139940</td>
      <td>0.670501</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.754305</td>
      <td>0.679514</td>
      <td>0.668471</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.691004</td>
      <td>0.661615</td>
      <td>0.668471</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.641002</td>
      <td>1.561577</td>
      <td>0.676590</td>
      <td>00:08</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.642796</td>
      <td>0.728456</td>
      <td>0.668471</td>
      <td>00:08</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [4.77]%
Sparsity at the end of epoch 1: [17.27]%
Sparsity at the end of epoch 2: [32.73]%
Sparsity at the end of epoch 3: [45.23]%
Sparsity at the end of epoch 4: [50.0]%
Final Sparsity: [50.0]%
Sparsity in Conv2d 2: 98.44%
Sparsity in Conv2d 8: 98.63%
Sparsity in Conv2d 11: 90.62%
Sparsity in Conv2d 14: 79.69%
Sparsity in Conv2d 17: 56.25%
Sparsity in Conv2d 21: 72.66%
Sparsity in Conv2d 24: 53.91%
Sparsity in Conv2d 27: 83.59%
Sparsity in Conv2d 30: 40.62%
Sparsity in Conv2d 33: 25.00%
Sparsity in Conv2d 37: 50.78%
Sparsity in Conv2d 40: 53.12%
Sparsity in Conv2d 43: 67.19%
Sparsity in Conv2d 46: 46.48%
Sparsity in Conv2d 49: 23.44%
Sparsity in Conv2d 53: 47.07%
Sparsity in Conv2d 56: 38.48%
Sparsity in Conv2d 59: 41.21%
Sparsity in Conv2d 62: 60.74%
Sparsity in Conv2d 65: 10.74%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="To-remove">To remove<a class="anchor-link" href="#To-remove"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fasterai.sparse.granularity</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Cell</span>
<span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="k">return</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">wf</span>

<span class="c1"># Cell</span>
<span class="n">random</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">large_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">squared_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">small_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">compose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">neg</span><span class="p">))</span>

<span class="c1"># Cell</span>
<span class="n">large_init</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">small_init</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">compose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">neg</span><span class="p">),</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">large_init_large_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">small_init_small_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>

<span class="c1"># Cell</span>
<span class="n">magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>

<span class="c1"># Cell</span>
<span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="n">updating_movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>

<span class="c1"># Cell</span>
<span class="n">updating_movmag</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="c1"># Put the mask into a buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>

    <span class="k">def</span> <span class="nf">_mask_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Reset non-pruned weights</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="n">global_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold locally</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">weight</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">weight</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SparsifyCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">lth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rewind_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reset_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_tickets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pruning of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="si">}</span><span class="s1"> until a sparsity of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">,</span> <span class="s1">&#39;You must rewind to an epoch before the start of the pruning process&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span> <span class="o">=</span> <span class="n">Sparsifier</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Weights at epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Intermediate Ticket&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resetting Weights to their epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="si">}</span><span class="s1"> values&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">after_pruned</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_apply_masks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">after_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sparsity_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%0.2f&quot;</span><span class="o">%</span><span class="k">sp</span>) for sp in self.current_sparsity]
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sparsity at the end of epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sparsity_str</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Final Ticket&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final Sparsity: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">current_sparsity</span><span class="si">:}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_end</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">print_sparsity</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>

<span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">large_final</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of filter until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.558005</td>
      <td>0.392734</td>
      <td>0.828823</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.366687</td>
      <td>0.325490</td>
      <td>0.863329</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.257937</td>
      <td>0.496581</td>
      <td>0.828823</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.221262</td>
      <td>0.231459</td>
      <td>0.903924</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.180329</td>
      <td>0.352036</td>
      <td>0.873478</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [4.77]%
Sparsity at the end of epoch 1: [17.27]%
Sparsity at the end of epoch 2: [32.73]%
Sparsity at the end of epoch 3: [45.23]%
Sparsity at the end of epoch 4: [50.0]%
Final Sparsity: [50.0]%
Sparsity in Conv2d 2: 12.50%
Sparsity in Conv2d 8: 0.00%
Sparsity in Conv2d 11: 0.00%
Sparsity in Conv2d 14: 0.00%
Sparsity in Conv2d 17: 0.00%
Sparsity in Conv2d 21: 0.00%
Sparsity in Conv2d 24: 0.00%
Sparsity in Conv2d 27: 0.78%
Sparsity in Conv2d 30: 0.00%
Sparsity in Conv2d 33: 2.34%
Sparsity in Conv2d 37: 0.00%
Sparsity in Conv2d 40: 3.12%
Sparsity in Conv2d 43: 2.34%
Sparsity in Conv2d 46: 54.30%
Sparsity in Conv2d 49: 67.19%
Sparsity in Conv2d 53: 99.22%
Sparsity in Conv2d 56: 99.80%
Sparsity in Conv2d 59: 3.71%
Sparsity in Conv2d 62: 99.80%
Sparsity in Conv2d 65: 99.80%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">debug</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&gt; <span class="ansi-green-fg">/tmp/ipykernel_1952159/3551873890.py</span>(27)<span class="ansi-cyan-fg">granularize</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">     25 </span><span class="ansi-red-fg">            </span>dim <span class="ansi-blue-fg">=</span> granularities<span class="ansi-blue-fg">[</span>m<span class="ansi-blue-fg">.</span>__class__<span class="ansi-blue-fg">.</span>__name__<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span>g<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">     26 </span><span class="ansi-red-fg">            </span><span class="ansi-red-fg">#if hasattr(m, &#39;_mask&#39;) == False: m.register_buffer(&#34;_mask&#34;, torch.ones_like(scores[None].mean(dim=dim, keepdim=True).squeeze(0))) # Put the mask into a buffer</span>
<span class="ansi-green-fg">---&gt; 27 </span><span class="ansi-red-fg">            </span>scores <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>rescale<span class="ansi-blue-fg">(</span>scores<span class="ansi-blue-fg">,</span> min_value<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>mean<span class="ansi-blue-fg">(</span>dim<span class="ansi-blue-fg">=</span>dim<span class="ansi-blue-fg">,</span> keepdim<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>squeeze<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>mul_<span class="ansi-blue-fg">(</span>m<span class="ansi-blue-fg">.</span>_mask<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">     28 </span><span class="ansi-red-fg">        </span><span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">raise</span> NameError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Invalid Granularity&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">     29 </span><span class="ansi-red-fg">        </span><span class="ansi-green-fg">return</span> scores

ipdb&gt; self.rescale(scores, min_value)[None].mean(dim=dim, keepdim=True).squeeze(0) * m._mask
tensor([[[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        [[[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]]],


        [[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        ...,


        [[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        [[[0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008]],

         [[0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008]],

         [[0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008]]],


        [[[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]]]],
       device=&#39;cuda:0&#39;, grad_fn=&lt;MulBackward0&gt;)
ipdb&gt; self.rescale(scores, min_value)[None].mean(dim=dim, keepdim=True).squeeze(0).mul(m._mask)
tensor([[[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        [[[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]]],


        [[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        ...,


        [[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        [[[0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008]],

         [[0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008]],

         [[0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008],
          [0.0008, 0.0008, 0.0008,  ..., 0.0008, 0.0008, 0.0008]]],


        [[[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]],

         [[0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          ...,
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009],
          [0.0009, 0.0009, 0.0009,  ..., 0.0009, 0.0009, 0.0009]]]],
       device=&#39;cuda:0&#39;, grad_fn=&lt;MulBackward0&gt;)
ipdb&gt; self.rescale(scores, min_value).mul_(m._mask)[None].mean(dim=dim, keepdim=True).squeeze(0)
tensor([[[[0.0010]]],


        [[[0.0009]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0008]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0009]]],


        [[[0.0010]]],


        [[[0.0009]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0009]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0008]]],


        [[[0.0011]]],


        [[[0.0012]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0009]]],


        [[[0.0011]]],


        [[[0.0011]]],


        [[[0.0009]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0011]]],


        [[[0.0008]]],


        [[[0.0009]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0009]]],


        [[[0.0010]]],


        [[[0.0010]]],


        [[[0.0008]]],


        [[[0.0009]]]], device=&#39;cuda:0&#39;, grad_fn=&lt;SqueezeBackward1&gt;)
ipdb&gt; quit
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="New">New<a class="anchor-link" href="#New"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.callback.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fasterai.sparse.sparsifier</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fasterai.sparse.criteria</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fasterai.sparse.schedule</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]),</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.6500)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">)</span> <span class="c1"># We don&#39;t want to scale individual layers in global</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">)</span> <span class="c1"># We don&#39;t want to scale individual layers in global</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all weights</span>
                <span class="n">global_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all masks</span>
                <span class="n">global_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_weight</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># Rescale all weights, apply the mask, then descale</span>
                <span class="c1">#global_weight = self.criteria.rescale(global_weight).mul_(global_mask.squeeze()) # Rescale all weights, apply the mask, then descale</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
                <span class="c1">#self.threshold-=(self.criteria.min_value+torch.finfo(torch.float32).eps)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold locally</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">weight</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">weight</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SparsifyCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">lth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rewind_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reset_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_tickets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pruning of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="si">}</span><span class="s1"> until a sparsity of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">,</span> <span class="s1">&#39;You must rewind to an epoch before the start of the pruning process&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span> <span class="o">=</span> <span class="n">Sparsifier</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Weights at epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Intermediate Ticket&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resetting Weights to their epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="si">}</span><span class="s1"> values&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">after_pruned</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_apply_masks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">after_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sparsity_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%0.2f&quot;</span><span class="o">%</span><span class="k">sp</span>) for sp in self.current_sparsity]
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sparsity at the end of epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sparsity_str</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Final Ticket&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final Sparsity: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">current_sparsity</span><span class="si">:}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_end</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">print_sparsity</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>

<span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">updating_magnitude_increase</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="c1">#print(self.min_value.abs())</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="c1">#print(self.min_value.abs())</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fasterai.sparse.granularity</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">)</span> <span class="c1"># We don&#39;t want to scale individual layers in global</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">)</span> <span class="c1"># We don&#39;t want to scale individual layers in global</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
                <span class="c1">#print(&#39;GW init&#39;, global_scores)</span>
                <span class="n">global_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all masks</span>
                <span class="c1">#print(global_mask)</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span>
                <span class="c1">#print(&#39;GW after rescale&#39;, global_scores)</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">global_scores</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span><span class="c1"># Rescale all scores, apply the mask, then descale</span>
                <span class="c1">#print(&#39;GW after mask&#39;, global_scores)</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span>
                <span class="c1">#print(&#39;GW after dscale&#39;, global_scores)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold locally</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="c1">#print(&#39;Thresh&#39;, threshold)</span>
        <span class="c1">#print(&#39;Weight&#39;,scores)</span>
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
            



<span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="c1">#scores = scores.mul_(m._mask) # We don&#39;t want to scale individual layers in global</span>
        <span class="c1">#if k==2: </span>
        <span class="c1">#    print(m._mask[0].squeeze())</span>
        <span class="c1">#    print(scores[0])</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
                <span class="c1">#print(&#39;GS&#39;, global_scores)</span>
                <span class="n">global_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all masks</span>
                <span class="n">global_scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span>
                <span class="c1">#print(&#39;GS rescaled&#39;, global_scores)</span>
                <span class="c1">#print(&#39;min_value&#39;, self.min_value)</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">global_scores</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span><span class="c1"># Rescale all scores, apply the mask, then descale</span>
                <span class="c1">#print(&#39;GS pruned&#39;, global_scores)</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span>
                <span class="c1">#print(&#39;GS descaled&#39;, global_scores)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold locally</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span> <span class="c1"># We don&#39;t want to scale individual layers in globa</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;global&#39;</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span>
        <span class="c1">#print(&#39;Scores&#39;, scores)</span>
        <span class="c1">#print(&#39;Thresh&#39;, threshold)</span>
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="kc">None</span>
        
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">granularize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>
    
    <span class="k">def</span> <span class="nf">get_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularize</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">min_value</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="c1">#def descale(self, w):</span>
    <span class="c1">#    output = w - self.min_value.abs()</span>
    <span class="c1">#    return output</span>
    
    <span class="c1">#def get_min(self, w):</span>
    <span class="c1">#    return w.view(-1)[w.argmin()]</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_criteria</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">get_scores</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="n">global_criteria</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">get_scores</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">min_value</span><span class="p">)</span> <span class="c1"># min_value is computed only once per prune_model</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">scores</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">get_scores</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span> <span class="n">scores</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SparsifyCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">lth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rewind_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reset_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_tickets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pruning of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="si">}</span><span class="s1"> until a sparsity of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">,</span> <span class="s1">&#39;You must rewind to an epoch before the start of the pruning process&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span> <span class="o">=</span> <span class="n">Sparsifier</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Weights at epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Intermediate Ticket&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resetting Weights to their epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="si">}</span><span class="s1"> values&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">after_pruned</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_apply_masks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">after_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sparsity_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%0.2f&quot;</span><span class="o">%</span><span class="k">sp</span>) for sp in self.current_sparsity]
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sparsity at the end of epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sparsity_str</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Final Ticket&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final Sparsity: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">current_sparsity</span><span class="si">:}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_end</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">print_sparsity</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
<span class="n">magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
<span class="n">large_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span>
<span class="n">random</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">)</span>
<span class="c1">#updating_magnitude_increase = Criteria(torch.abs, needs_update=True, output_f= lambda x,y: torch.sub(x,y))</span>
<span class="n">updating_movmag</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fasterai.sparse.granularity</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">magnitude_increase</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of weight until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.596600</td>
      <td>0.563079</td>
      <td>0.696888</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.570330</td>
      <td>0.507912</td>
      <td>0.742219</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.522023</td>
      <td>0.502796</td>
      <td>0.747632</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.479169</td>
      <td>0.475754</td>
      <td>0.763193</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.446757</td>
      <td>0.442324</td>
      <td>0.788227</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.391162</td>
      <td>0.382815</td>
      <td>0.831529</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.370418</td>
      <td>0.392972</td>
      <td>0.814614</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.312489</td>
      <td>0.352564</td>
      <td>0.837618</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.286520</td>
      <td>0.392177</td>
      <td>0.824763</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.237663</td>
      <td>0.371976</td>
      <td>0.859946</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [1.22]%
Sparsity at the end of epoch 1: [4.77]%
Sparsity at the end of epoch 2: [10.31]%
Sparsity at the end of epoch 3: [17.27]%
Sparsity at the end of epoch 4: [25.0]%
Sparsity at the end of epoch 5: [32.73]%
Sparsity at the end of epoch 6: [39.69]%
Sparsity at the end of epoch 7: [45.23]%
Sparsity at the end of epoch 8: [48.78]%
Sparsity at the end of epoch 9: [50.0]%
Final Sparsity: [50.0]%
Sparsity in Conv2d 1: 57.26%
Sparsity in Conv2d 7: 66.60%
Sparsity in Conv2d 10: 66.29%
Sparsity in Conv2d 13: 67.00%
Sparsity in Conv2d 16: 66.91%
Sparsity in Conv2d 20: 66.38%
Sparsity in Conv2d 23: 67.30%
Sparsity in Conv2d 26: 70.37%
Sparsity in Conv2d 29: 66.94%
Sparsity in Conv2d 32: 66.56%
Sparsity in Conv2d 36: 66.06%
Sparsity in Conv2d 39: 63.82%
Sparsity in Conv2d 42: 70.28%
Sparsity in Conv2d 45: 61.56%
Sparsity in Conv2d 48: 57.46%
Sparsity in Conv2d 52: 52.97%
Sparsity in Conv2d 55: 46.10%
Sparsity in Conv2d 58: 63.64%
Sparsity in Conv2d 61: 44.09%
Sparsity in Conv2d 64: 42.23%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;scores&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">min_value</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-0.0010, device=&#39;cuda:0&#39;, grad_fn=&lt;SelectBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">global_scs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">get_scores</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">get_min</span><span class="p">(</span><span class="n">global_criteria</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>    <span class="k">def</span> <span class="nf">granularize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>
    
    <span class="k">def</span> <span class="nf">get_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularize</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">min_value</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">get_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[[[-3.3144e-04, -3.1918e-04, -3.4335e-04,  ...,  3.3004e-04,
            1.9391e-04, -2.5945e-04],
          [ 2.0925e-04,  1.7628e-04, -2.0480e-04,  ..., -2.7353e-04,
           -2.5964e-04,  2.1820e-04],
          [-2.0804e-04,  2.3791e-04,  2.4399e-04,  ...,  2.9409e-04,
            2.4548e-04,  2.1187e-04],
          ...,
          [-8.4434e-05,  8.2493e-05, -1.1325e-06,  ..., -2.8819e-04,
           -2.4536e-04, -2.1890e-04],
          [ 6.2760e-05,  7.0795e-05, -4.2699e-05,  ...,  2.3955e-04,
            1.3757e-04,  1.8336e-04],
          [-4.3441e-05, -5.4070e-05, -1.0069e-04,  ..., -1.4922e-04,
           -3.3379e-05, -1.5076e-04]],

         [[-4.3890e-04, -3.7444e-04, -3.8284e-04,  ...,  3.9039e-04,
            2.8816e-04, -3.7799e-04],
          [ 2.9835e-04,  2.5048e-04, -2.8243e-04,  ..., -3.5775e-04,
           -3.8518e-04, -3.3346e-04],
          [-2.6954e-04,  2.9063e-04,  3.2023e-04,  ...,  3.7491e-04,
            3.6588e-04,  3.0197e-04],
          ...,
          [-1.2656e-04, -7.2401e-05,  4.1192e-05,  ..., -3.9968e-04,
           -3.7676e-04, -3.1322e-04],
          [ 9.2570e-05,  4.0483e-05, -5.3547e-05,  ...,  0.0000e+00,
            2.2745e-04,  2.5685e-04],
          [ 9.8230e-05,  4.7730e-05, -7.1051e-05,  ..., -2.1550e-04,
           -1.2256e-04, -2.1886e-04]],

         [[ 7.8092e-04, -6.6559e-04,  6.4549e-04,  ...,  5.8065e-04,
            5.1550e-04, -5.7230e-04],
          [ 6.6384e-04, -5.7723e-04, -5.9432e-04,  ..., -5.8512e-04,
           -6.2011e-04, -5.5517e-04],
          [ 6.2386e-04,  5.8434e-04,  5.8521e-04,  ...,  5.9587e-04,
            5.8930e-04,  5.1679e-04],
          ...,
          [-4.3719e-04,  3.5231e-04,  3.0484e-04,  ..., -6.5505e-04,
           -5.9533e-04, -5.1524e-04],
          [ 3.6376e-04, -2.8929e-04, -2.2778e-04,  ...,  6.1174e-04,
            4.9141e-04,  4.7650e-04],
          [ 3.3179e-04,  2.4332e-04, -2.8578e-04,  ..., -4.9752e-04,
           -3.5613e-04, -3.9281e-04]]],


        [[[-1.2585e-04, -2.5886e-04,  3.2665e-04,  ..., -3.4992e-04,
           -2.0191e-04, -1.8906e-04],
          [ 2.6297e-05,  1.5686e-04,  1.7621e-04,  ...,  2.2529e-04,
            1.5993e-04,  1.0419e-04],
          [-8.0564e-05,  2.4889e-04,  1.5916e-04,  ...,  3.0969e-04,
            1.9268e-04,  1.4362e-04],
          ...,
          [-1.2355e-04, -2.3226e-04, -5.7667e-05,  ..., -3.2130e-04,
           -2.4065e-04, -2.3525e-04],
          [ 1.0460e-04, -2.4335e-04, -2.2093e-04,  ..., -4.8937e-04,
           -3.5599e-04, -3.1879e-04],
          [ 1.1960e-04,  1.8635e-04,  2.3850e-04,  ...,  5.5231e-04,
            4.0008e-04,  3.3582e-04]],

         [[-7.2374e-05,  2.6280e-04,  3.5218e-04,  ...,  3.7677e-04,
            2.3657e-04, -2.6416e-04],
          [ 7.0084e-05,  2.0251e-04,  2.3527e-04,  ...,  2.7841e-04,
            2.3589e-04,  1.9839e-04],
          [-1.1152e-04, -2.6606e-04,  2.0768e-04,  ...,  4.0168e-04,
            2.7700e-04,  2.3864e-04],
          ...,
          [-1.4636e-04, -2.5934e-04, -6.7025e-05,  ..., -4.8709e-04,
           -3.3769e-04, -3.3838e-04],
          [ 1.8742e-04, -3.1423e-04, -3.0451e-04,  ..., -6.9997e-04,
           -5.1052e-04, -4.1980e-04],
          [ 2.3142e-04,  2.8688e-04,  3.3598e-04,  ...,  7.2668e-04,
            5.6131e-04,  4.2578e-04]],

         [[-2.2763e-05, -1.5359e-04,  2.0038e-04,  ...,  2.7895e-04,
            2.6812e-04, -3.6456e-04],
          [ 1.3581e-04,  2.0230e-04,  2.1207e-04,  ...,  3.1996e-04,
            3.4207e-04,  3.6031e-04],
          [-1.9113e-04, -2.5232e-04,  1.9227e-04,  ...,  4.5109e-04,
            3.9276e-04,  3.7660e-04],
          ...,
          [-2.1584e-04, -2.6898e-04, -7.8976e-05,  ..., -6.0733e-04,
           -5.6171e-04, -4.8898e-04],
          [ 2.3721e-04, -2.4289e-04, -2.2273e-04,  ..., -7.1803e-04,
           -6.5264e-04, -4.9591e-04],
          [ 2.8685e-04,  2.4354e-04,  2.1915e-04,  ...,  5.4258e-04,
            5.1527e-04,  4.2753e-04]]],


        [[[-7.1054e-13, -6.4659e-13, -7.3896e-13,  ..., -9.8055e-13,
           -1.0942e-12, -8.3844e-13],
          [-6.1284e-14, -2.0650e-14, -8.0824e-14,  ..., -4.9738e-13,
           -4.4054e-13, -3.0642e-14],
          [-7.1765e-13, -7.6028e-13, -5.9330e-13,  ..., -9.7700e-14,
           -1.0991e-14, -4.2633e-13],
          ...,
          [-9.5923e-13, -1.0019e-12, -7.9581e-13,  ..., -1.7586e-13,
           -4.7606e-13, -1.3323e-13],
          [-1.2932e-12, -1.4779e-12, -1.7479e-12,  ..., -1.3216e-12,
           -1.0658e-12, -9.3792e-13],
          [-1.2506e-12, -1.3642e-12, -1.8474e-12,  ..., -2.1458e-12,
           -1.7764e-12, -1.7195e-12]],

         [[-1.2648e-12, -9.5923e-13, -1.0374e-12,  ..., -1.1795e-12,
           -1.3358e-12, -1.0800e-12],
          [-5.7554e-13, -2.5047e-13, -3.0198e-13,  ..., -7.3186e-13,
           -6.6791e-13, -2.2560e-13],
          [-2.1849e-13, -4.8672e-13, -3.1264e-13,  ..., -1.8652e-13,
           -7.9936e-14, -3.9790e-13],
          ...,
          [-5.6133e-13, -7.5318e-13, -4.4409e-13,  ..., -4.4054e-13,
           -5.9686e-13, -1.8296e-13],
          [-7.7449e-13, -9.8765e-13, -1.0445e-12,  ..., -6.3238e-13,
           -4.1922e-13, -4.5830e-13],
          [-5.9686e-13, -7.1054e-13, -9.0239e-13,  ..., -1.1653e-12,
           -8.7397e-13, -9.8765e-13]],

         [[-4.3698e-13, -1.3323e-13, -7.8160e-14,  ..., -5.9064e-14,
           -2.6290e-13, -1.5632e-13],
          [-4.1922e-13, -1.0800e-12, -1.0942e-12,  ..., -7.6739e-13,
           -7.1765e-13, -9.8055e-13],
          [-1.0445e-12, -1.6627e-12, -1.5916e-12,  ..., -1.3500e-12,
           -1.3500e-12, -1.6485e-12],
          ...,
          [-9.8765e-13, -1.5064e-12, -1.2506e-12,  ..., -6.8212e-13,
           -6.8212e-13, -1.1369e-12],
          [-9.1660e-13, -1.3642e-12, -1.3785e-12,  ..., -1.1724e-12,
           -1.1724e-12, -1.4353e-12],
          [-6.2528e-13, -8.8107e-13, -1.0445e-12,  ..., -1.3927e-12,
           -1.3358e-12, -1.5916e-12]]],


        ...,


        [[[-8.6904e-04, -8.4894e-04,  7.9927e-04,  ...,  7.9363e-04,
           -4.5269e-04, -6.0248e-04],
          [-8.1012e-04,  8.2050e-04,  7.9072e-04,  ...,  7.0001e-04,
            2.5748e-04,  2.6945e-05],
          [-7.6672e-04,  6.7008e-04,  6.0956e-04,  ...,  4.5993e-04,
            1.2256e-04, -7.0671e-05],
          ...,
          [ 6.5641e-04,  1.6475e-04,  2.5021e-04,  ..., -5.6136e-05,
            9.5177e-05, -1.3975e-04],
          [-7.4311e-04, -2.5973e-04,  2.0902e-04,  ..., -4.2551e-04,
            2.6818e-04,  2.2633e-04],
          [-6.2624e-04, -1.1007e-04,  2.8012e-04,  ..., -2.7156e-04,
           -2.6215e-04,  2.6566e-04]],

         [[-7.7405e-04, -5.4897e-04,  4.8165e-04,  ...,  5.2210e-04,
           -2.2935e-04, -2.8875e-04],
          [-8.2406e-04,  7.0529e-04,  6.1416e-04,  ...,  6.1457e-04,
            2.5998e-04, -1.1078e-04],
          [-7.8529e-04,  7.2722e-04,  4.9793e-04,  ...,  5.6629e-04,
           -2.2814e-05, -1.7570e-04],
          ...,
          [ 5.9857e-04,  5.6561e-05,  2.3614e-04,  ..., -2.3817e-04,
            5.5708e-05,  3.2766e-04],
          [-5.5145e-04,  2.3667e-04,  9.6943e-05,  ..., -3.6980e-04,
           -2.0518e-04,  9.0559e-05],
          [-5.3308e-04,  1.6965e-04, -2.5730e-04,  ..., -3.1097e-04,
           -2.1714e-04,  1.9961e-04]],

         [[-7.8655e-04, -6.6515e-04,  6.4316e-04,  ...,  6.8756e-04,
           -3.9407e-04, -4.1086e-04],
          [-8.6101e-04,  8.1302e-04,  7.9565e-04,  ...,  8.4542e-04,
            2.6228e-04, -3.8486e-05],
          [-7.4761e-04,  6.8086e-04,  5.9993e-04,  ...,  4.7606e-04,
            1.8442e-04, -2.1681e-06],
          ...,
          [-5.4715e-04,  1.9849e-04,  3.9772e-04,  ...,  1.9206e-04,
           -2.6702e-04, -5.5816e-04],
          [-5.1322e-04, -1.9236e-04,  1.9207e-04,  ..., -8.0660e-05,
            3.6270e-05, -8.8178e-05],
          [-4.5972e-04,  1.5248e-04, -5.4374e-05,  ..., -1.6878e-04,
           -1.0406e-04,  4.2112e-05]]],


        [[[ 1.1352e-04, -2.3189e-04, -2.7893e-04,  ..., -5.8590e-04,
           -1.7842e-04,  2.8087e-05],
          [ 7.9070e-05,  5.1564e-05,  1.9996e-04,  ..., -6.8858e-04,
           -1.1953e-04,  4.0517e-04],
          [-2.1073e-04, -3.9864e-04, -1.1776e-04,  ..., -4.5086e-04,
            9.6641e-05,  4.8853e-04],
          ...,
          [ 4.1895e-04,  4.8359e-04,  3.8038e-05,  ...,  4.1355e-06,
            2.0843e-04,  3.2214e-04],
          [ 3.9389e-04,  2.3630e-04,  2.5790e-05,  ...,  1.9319e-04,
            3.3343e-04,  4.1148e-04],
          [ 5.6018e-04,  4.9015e-04,  4.2643e-04,  ...,  3.6970e-04,
            5.0580e-04,  4.8329e-04]],

         [[ 7.4025e-05, -9.4887e-05, -1.0080e-04,  ...,  5.0498e-04,
            2.8386e-05,  2.2475e-04],
          [-5.0457e-05, -1.1731e-04, -7.9520e-05,  ..., -6.5706e-04,
           -5.5134e-07,  5.2929e-04],
          [-1.6361e-04, -5.9307e-04, -4.1223e-04,  ..., -4.3448e-04,
            1.2499e-04,  5.7054e-04],
          ...,
          [ 3.7687e-04, -7.7112e-04, -1.7964e-04,  ...,  6.0303e-07,
            2.7341e-04,  3.8639e-04],
          [ 3.6994e-04,  4.5240e-04,  1.2206e-04,  ...,  1.2392e-04,
            3.5541e-04,  4.4945e-04],
          [-5.7531e-04,  6.1655e-04,  4.7375e-04,  ..., -2.9809e-04,
            4.7820e-04,  4.8137e-04]],

         [[ 3.0337e-04,  2.7763e-04, -1.7796e-04,  ...,  4.8358e-04,
           -1.5804e-04, -3.5433e-04],
          [ 3.7647e-04,  3.5135e-04,  3.0509e-04,  ...,  5.7623e-04,
           -2.1577e-05, -4.4085e-04],
          [ 1.8969e-04,  2.4454e-04,  2.2849e-04,  ...,  5.0501e-04,
           -1.2124e-04, -5.2574e-04],
          ...,
          [ 9.7818e-05, -7.4751e-05,  2.5805e-04,  ...,  3.1158e-04,
           -1.3677e-04, -2.4750e-04],
          [ 6.8858e-05,  3.1424e-05, -2.7046e-04,  ...,  2.2599e-04,
            1.9263e-04, -2.7891e-04],
          [-3.1162e-04, -3.2638e-04, -1.7051e-04,  ..., -4.0129e-05,
           -2.9694e-04, -3.3495e-04]]],


        [[[ 4.1216e-04, -1.9831e-04, -1.6797e-04,  ..., -1.1450e-05,
            1.9640e-05, -5.0569e-05],
          [ 2.5212e-04, -2.0190e-04, -1.3407e-04,  ...,  1.2434e-04,
           -1.3850e-04, -1.2483e-04],
          [-2.1975e-04, -2.0221e-04, -8.8252e-05,  ..., -6.8083e-05,
           -3.0100e-05, -7.2725e-05],
          ...,
          [ 1.1750e-04,  5.8115e-05,  1.4338e-04,  ...,  4.8280e-06,
            4.3541e-05,  1.3473e-04],
          [-1.7955e-04, -1.9152e-04,  1.0860e-04,  ...,  1.2682e-04,
           -1.0862e-04, -2.0244e-04],
          [-4.0270e-04,  2.5880e-04,  1.6352e-04,  ..., -2.1666e-04,
           -2.3279e-04, -2.9883e-04]],

         [[ 3.9849e-04, -7.9185e-05, -2.8191e-05,  ..., -1.2506e-04,
           -1.9356e-04, -1.9540e-04],
          [-2.8281e-04, -1.2228e-04, -1.9073e-06,  ..., -2.3163e-04,
           -2.4356e-04, -1.8345e-04],
          [-2.6762e-04,  0.0000e+00, -3.7756e-05,  ..., -1.3402e-04,
           -1.4585e-04, -1.7186e-04],
          ...,
          [ 1.2365e-04, -5.0783e-05,  5.5879e-05,  ...,  2.7269e-05,
            1.1384e-04,  2.1859e-04],
          [-2.4480e-04, -3.0971e-04,  2.2112e-04,  ...,  2.0769e-04,
            2.3259e-04, -3.0828e-04],
          [ 4.1378e-04,  3.3271e-04,  2.5587e-04,  ...,  3.1947e-04,
           -3.3649e-04, -3.5989e-04]],

         [[ 1.4121e-04,  1.2737e-04, -1.3521e-04,  ...,  1.8655e-04,
            1.5655e-04,  1.9725e-04],
          [-1.2920e-06,  1.0746e-04,  1.7328e-04,  ...,  2.5312e-04,
           -2.4189e-04,  2.1137e-04],
          [ 4.2211e-05,  1.3388e-04,  2.4034e-04,  ..., -2.3255e-04,
           -2.2399e-04, -2.2176e-04],
          ...,
          [-2.1140e-04, -3.4189e-04, -2.5313e-04,  ...,  2.0485e-04,
            2.5709e-04,  2.8732e-04],
          [-3.8829e-04, -4.5652e-04,  3.7189e-04,  ...,  3.3320e-04,
            3.5398e-04, -3.7044e-04],
          [-4.1519e-04, -4.4337e-04,  3.6917e-04,  ..., -3.9689e-04,
           -4.0812e-04, -4.0868e-04]]]], device=&#39;cuda:0&#39;,
       grad_fn=&lt;SubBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(True, device=&#39;cuda:0&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([[[[0.0007, 0.0007, 0.0007,  ..., 0.0013, 0.0012, 0.0007],
          [0.0012, 0.0012, 0.0008,  ..., 0.0007, 0.0007, 0.0012],
          [0.0008, 0.0012, 0.0012,  ..., 0.0013, 0.0012, 0.0012],
          ...,
          [0.0009, 0.0011, 0.0010,  ..., 0.0007, 0.0008, 0.0008],
          [0.0011, 0.0011, 0.0010,  ..., 0.0012, 0.0011, 0.0012],
          [0.0010, 0.0009, 0.0009,  ..., 0.0008, 0.0010, 0.0008]],

         [[0.0006, 0.0006, 0.0006,  ..., 0.0014, 0.0013, 0.0006],
          [0.0013, 0.0012, 0.0007,  ..., 0.0006, 0.0006, 0.0007],
          [0.0007, 0.0013, 0.0013,  ..., 0.0014, 0.0014, 0.0013],
          ...,
          [0.0009, 0.0009, 0.0010,  ..., 0.0006, 0.0006, 0.0007],
          [0.0011, 0.0010, 0.0009,  ..., 0.0010, 0.0012, 0.0013],
          [0.0011, 0.0010, 0.0009,  ..., 0.0008, 0.0009, 0.0008]],

         [[0.0018, 0.0003, 0.0016,  ..., 0.0016, 0.0015, 0.0004],
          [0.0017, 0.0004, 0.0004,  ..., 0.0004, 0.0004, 0.0004],
          [0.0016, 0.0016, 0.0016,  ..., 0.0016, 0.0016, 0.0015],
          ...,
          [0.0006, 0.0014, 0.0013,  ..., 0.0003, 0.0004, 0.0005],
          [0.0014, 0.0007, 0.0008,  ..., 0.0016, 0.0015, 0.0015],
          [0.0013, 0.0012, 0.0007,  ..., 0.0005, 0.0006, 0.0006]]],


        [[[0.0009, 0.0007, 0.0013,  ..., 0.0006, 0.0008, 0.0008],
          [0.0010, 0.0012, 0.0012,  ..., 0.0012, 0.0012, 0.0011],
          [0.0009, 0.0012, 0.0012,  ..., 0.0013, 0.0012, 0.0011],
          ...,
          [0.0009, 0.0008, 0.0009,  ..., 0.0007, 0.0008, 0.0008],
          [0.0011, 0.0008, 0.0008,  ..., 0.0005, 0.0006, 0.0007],
          [0.0011, 0.0012, 0.0012,  ..., 0.0016, 0.0014, 0.0013]],

         [[0.0009, 0.0013, 0.0014,  ..., 0.0014, 0.0012, 0.0007],
          [0.0011, 0.0012, 0.0012,  ..., 0.0013, 0.0012, 0.0012],
          [0.0009, 0.0007, 0.0012,  ..., 0.0014, 0.0013, 0.0012],
          ...,
          [0.0009, 0.0007, 0.0009,  ..., 0.0005, 0.0007, 0.0007],
          [0.0012, 0.0007, 0.0007,  ..., 0.0003, 0.0005, 0.0006],
          [0.0012, 0.0013, 0.0013,  ..., 0.0017, 0.0016, 0.0014]],

         [[0.0010, 0.0008, 0.0012,  ..., 0.0013, 0.0013, 0.0006],
          [0.0011, 0.0012, 0.0012,  ..., 0.0013, 0.0013, 0.0014],
          [0.0008, 0.0007, 0.0012,  ..., 0.0015, 0.0014, 0.0014],
          ...,
          [0.0008, 0.0007, 0.0009,  ..., 0.0004, 0.0004, 0.0005],
          [0.0012, 0.0008, 0.0008,  ..., 0.0003, 0.0003, 0.0005],
          [0.0013, 0.0012, 0.0012,  ..., 0.0015, 0.0015, 0.0014]]],


        [[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        ...,


        [[[0.0001, 0.0002, 0.0018,  ..., 0.0018, 0.0005, 0.0004],
          [0.0002, 0.0018, 0.0018,  ..., 0.0017, 0.0013, 0.0010],
          [0.0002, 0.0017, 0.0016,  ..., 0.0015, 0.0011, 0.0009],
          ...,
          [0.0017, 0.0012, 0.0012,  ..., 0.0009, 0.0011, 0.0009],
          [0.0003, 0.0007, 0.0012,  ..., 0.0006, 0.0013, 0.0012],
          [0.0004, 0.0009, 0.0013,  ..., 0.0007, 0.0007, 0.0013]],

         [[0.0002, 0.0005, 0.0015,  ..., 0.0015, 0.0008, 0.0007],
          [0.0002, 0.0017, 0.0016,  ..., 0.0016, 0.0013, 0.0009],
          [0.0002, 0.0017, 0.0015,  ..., 0.0016, 0.0010, 0.0008],
          ...,
          [0.0016, 0.0011, 0.0012,  ..., 0.0008, 0.0011, 0.0013],
          [0.0004, 0.0012, 0.0011,  ..., 0.0006, 0.0008, 0.0011],
          [0.0005, 0.0012, 0.0007,  ..., 0.0007, 0.0008, 0.0012]],

         [[0.0002, 0.0003, 0.0016,  ..., 0.0017, 0.0006, 0.0006],
          [0.0001, 0.0018, 0.0018,  ..., 0.0018, 0.0013, 0.0010],
          [0.0003, 0.0017, 0.0016,  ..., 0.0015, 0.0012, 0.0010],
          ...,
          [0.0005, 0.0012, 0.0014,  ..., 0.0012, 0.0007, 0.0004],
          [0.0005, 0.0008, 0.0012,  ..., 0.0009, 0.0010, 0.0009],
          [0.0005, 0.0012, 0.0009,  ..., 0.0008, 0.0009, 0.0010]]],


        [[[0.0011, 0.0008, 0.0007,  ..., 0.0004, 0.0008, 0.0010],
          [0.0011, 0.0011, 0.0012,  ..., 0.0003, 0.0009, 0.0014],
          [0.0008, 0.0006, 0.0009,  ..., 0.0005, 0.0011, 0.0015],
          ...,
          [0.0014, 0.0015, 0.0010,  ..., 0.0010, 0.0012, 0.0013],
          [0.0014, 0.0012, 0.0010,  ..., 0.0012, 0.0013, 0.0014],
          [0.0016, 0.0015, 0.0014,  ..., 0.0014, 0.0015, 0.0015]],

         [[0.0011, 0.0009, 0.0009,  ..., 0.0015, 0.0010, 0.0012],
          [0.0009, 0.0009, 0.0009,  ..., 0.0003, 0.0010, 0.0015],
          [0.0008, 0.0004, 0.0006,  ..., 0.0006, 0.0011, 0.0016],
          ...,
          [0.0014, 0.0002, 0.0008,  ..., 0.0010, 0.0013, 0.0014],
          [0.0014, 0.0015, 0.0011,  ..., 0.0011, 0.0014, 0.0014],
          [0.0004, 0.0016, 0.0015,  ..., 0.0007, 0.0015, 0.0015]],

         [[0.0013, 0.0013, 0.0008,  ..., 0.0015, 0.0008, 0.0006],
          [0.0014, 0.0014, 0.0013,  ..., 0.0016, 0.0010, 0.0006],
          [0.0012, 0.0012, 0.0012,  ..., 0.0015, 0.0009, 0.0005],
          ...,
          [0.0011, 0.0009, 0.0013,  ..., 0.0013, 0.0009, 0.0008],
          [0.0011, 0.0010, 0.0007,  ..., 0.0012, 0.0012, 0.0007],
          [0.0007, 0.0007, 0.0008,  ..., 0.0010, 0.0007, 0.0007]]],


        [[[0.0014, 0.0008, 0.0008,  ..., 0.0010, 0.0010, 0.0009],
          [0.0013, 0.0008, 0.0009,  ..., 0.0011, 0.0009, 0.0009],
          [0.0008, 0.0008, 0.0009,  ..., 0.0009, 0.0010, 0.0009],
          ...,
          [0.0011, 0.0011, 0.0011,  ..., 0.0010, 0.0010, 0.0011],
          [0.0008, 0.0008, 0.0011,  ..., 0.0011, 0.0009, 0.0008],
          [0.0006, 0.0013, 0.0012,  ..., 0.0008, 0.0008, 0.0007]],

         [[0.0014, 0.0009, 0.0010,  ..., 0.0009, 0.0008, 0.0008],
          [0.0007, 0.0009, 0.0010,  ..., 0.0008, 0.0008, 0.0008],
          [0.0007, 0.0010, 0.0010,  ..., 0.0009, 0.0009, 0.0008],
          ...,
          [0.0011, 0.0009, 0.0011,  ..., 0.0010, 0.0011, 0.0012],
          [0.0008, 0.0007, 0.0012,  ..., 0.0012, 0.0012, 0.0007],
          [0.0014, 0.0013, 0.0013,  ..., 0.0013, 0.0007, 0.0006]],

         [[0.0011, 0.0011, 0.0009,  ..., 0.0012, 0.0012, 0.0012],
          [0.0010, 0.0011, 0.0012,  ..., 0.0013, 0.0008, 0.0012],
          [0.0010, 0.0011, 0.0012,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0007, 0.0007,  ..., 0.0012, 0.0013, 0.0013],
          [0.0006, 0.0005, 0.0014,  ..., 0.0013, 0.0014, 0.0006],
          [0.0006, 0.0006, 0.0014,  ..., 0.0006, 0.0006, 0.0006]]]],
       device=&#39;cuda:0&#39;, grad_fn=&lt;AddBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([[[[0.0007, 0.0007, 0.0007,  ..., 0.0013, 0.0012, 0.0007],
          [0.0012, 0.0012, 0.0008,  ..., 0.0007, 0.0007, 0.0012],
          [0.0008, 0.0012, 0.0012,  ..., 0.0013, 0.0012, 0.0012],
          ...,
          [0.0009, 0.0011, 0.0010,  ..., 0.0007, 0.0008, 0.0008],
          [0.0011, 0.0011, 0.0010,  ..., 0.0012, 0.0011, 0.0012],
          [0.0010, 0.0009, 0.0009,  ..., 0.0008, 0.0010, 0.0008]],

         [[0.0006, 0.0006, 0.0006,  ..., 0.0014, 0.0013, 0.0006],
          [0.0013, 0.0012, 0.0007,  ..., 0.0006, 0.0006, 0.0007],
          [0.0007, 0.0013, 0.0013,  ..., 0.0014, 0.0014, 0.0013],
          ...,
          [0.0009, 0.0009, 0.0010,  ..., 0.0006, 0.0006, 0.0007],
          [0.0011, 0.0010, 0.0009,  ..., 0.0000, 0.0012, 0.0013],
          [0.0011, 0.0010, 0.0009,  ..., 0.0008, 0.0009, 0.0008]],

         [[0.0018, 0.0003, 0.0016,  ..., 0.0016, 0.0015, 0.0004],
          [0.0017, 0.0004, 0.0004,  ..., 0.0004, 0.0004, 0.0004],
          [0.0016, 0.0016, 0.0016,  ..., 0.0016, 0.0016, 0.0015],
          ...,
          [0.0006, 0.0014, 0.0013,  ..., 0.0003, 0.0004, 0.0005],
          [0.0014, 0.0007, 0.0008,  ..., 0.0016, 0.0015, 0.0015],
          [0.0013, 0.0012, 0.0007,  ..., 0.0005, 0.0006, 0.0006]]],


        [[[0.0009, 0.0007, 0.0013,  ..., 0.0006, 0.0008, 0.0008],
          [0.0010, 0.0012, 0.0012,  ..., 0.0012, 0.0012, 0.0011],
          [0.0009, 0.0012, 0.0012,  ..., 0.0013, 0.0012, 0.0011],
          ...,
          [0.0009, 0.0008, 0.0009,  ..., 0.0007, 0.0008, 0.0008],
          [0.0011, 0.0008, 0.0008,  ..., 0.0005, 0.0006, 0.0007],
          [0.0011, 0.0012, 0.0012,  ..., 0.0016, 0.0014, 0.0013]],

         [[0.0009, 0.0013, 0.0014,  ..., 0.0014, 0.0012, 0.0007],
          [0.0011, 0.0012, 0.0012,  ..., 0.0013, 0.0012, 0.0012],
          [0.0009, 0.0007, 0.0012,  ..., 0.0014, 0.0013, 0.0012],
          ...,
          [0.0009, 0.0007, 0.0009,  ..., 0.0005, 0.0007, 0.0007],
          [0.0012, 0.0007, 0.0007,  ..., 0.0003, 0.0005, 0.0006],
          [0.0012, 0.0013, 0.0013,  ..., 0.0017, 0.0016, 0.0014]],

         [[0.0010, 0.0008, 0.0012,  ..., 0.0013, 0.0013, 0.0006],
          [0.0011, 0.0012, 0.0012,  ..., 0.0013, 0.0013, 0.0014],
          [0.0008, 0.0007, 0.0012,  ..., 0.0015, 0.0014, 0.0014],
          ...,
          [0.0008, 0.0007, 0.0009,  ..., 0.0004, 0.0004, 0.0005],
          [0.0012, 0.0008, 0.0008,  ..., 0.0003, 0.0003, 0.0005],
          [0.0013, 0.0012, 0.0012,  ..., 0.0015, 0.0015, 0.0014]]],


        [[[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]],

         [[0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          ...,
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010],
          [0.0010, 0.0010, 0.0010,  ..., 0.0010, 0.0010, 0.0010]]],


        ...,


        [[[0.0001, 0.0002, 0.0018,  ..., 0.0018, 0.0005, 0.0004],
          [0.0002, 0.0018, 0.0018,  ..., 0.0017, 0.0013, 0.0010],
          [0.0002, 0.0017, 0.0016,  ..., 0.0015, 0.0011, 0.0009],
          ...,
          [0.0017, 0.0012, 0.0012,  ..., 0.0009, 0.0011, 0.0009],
          [0.0003, 0.0007, 0.0012,  ..., 0.0006, 0.0013, 0.0012],
          [0.0004, 0.0009, 0.0013,  ..., 0.0007, 0.0007, 0.0013]],

         [[0.0002, 0.0005, 0.0015,  ..., 0.0015, 0.0008, 0.0007],
          [0.0002, 0.0017, 0.0016,  ..., 0.0016, 0.0013, 0.0009],
          [0.0002, 0.0017, 0.0015,  ..., 0.0016, 0.0010, 0.0008],
          ...,
          [0.0016, 0.0011, 0.0012,  ..., 0.0008, 0.0011, 0.0013],
          [0.0004, 0.0012, 0.0011,  ..., 0.0006, 0.0008, 0.0011],
          [0.0005, 0.0012, 0.0007,  ..., 0.0007, 0.0008, 0.0012]],

         [[0.0002, 0.0003, 0.0016,  ..., 0.0017, 0.0006, 0.0006],
          [0.0001, 0.0018, 0.0018,  ..., 0.0018, 0.0013, 0.0010],
          [0.0003, 0.0017, 0.0016,  ..., 0.0015, 0.0012, 0.0010],
          ...,
          [0.0005, 0.0012, 0.0014,  ..., 0.0012, 0.0007, 0.0004],
          [0.0005, 0.0008, 0.0012,  ..., 0.0009, 0.0010, 0.0009],
          [0.0005, 0.0012, 0.0009,  ..., 0.0008, 0.0009, 0.0010]]],


        [[[0.0011, 0.0008, 0.0007,  ..., 0.0004, 0.0008, 0.0010],
          [0.0011, 0.0011, 0.0012,  ..., 0.0003, 0.0009, 0.0014],
          [0.0008, 0.0006, 0.0009,  ..., 0.0005, 0.0011, 0.0015],
          ...,
          [0.0014, 0.0015, 0.0010,  ..., 0.0010, 0.0012, 0.0013],
          [0.0014, 0.0012, 0.0010,  ..., 0.0012, 0.0013, 0.0014],
          [0.0016, 0.0015, 0.0014,  ..., 0.0014, 0.0015, 0.0015]],

         [[0.0011, 0.0009, 0.0009,  ..., 0.0015, 0.0010, 0.0012],
          [0.0009, 0.0009, 0.0009,  ..., 0.0003, 0.0010, 0.0015],
          [0.0008, 0.0004, 0.0006,  ..., 0.0006, 0.0011, 0.0016],
          ...,
          [0.0014, 0.0002, 0.0008,  ..., 0.0010, 0.0013, 0.0014],
          [0.0014, 0.0015, 0.0011,  ..., 0.0011, 0.0014, 0.0014],
          [0.0004, 0.0016, 0.0015,  ..., 0.0007, 0.0015, 0.0015]],

         [[0.0013, 0.0013, 0.0008,  ..., 0.0015, 0.0008, 0.0006],
          [0.0014, 0.0014, 0.0013,  ..., 0.0016, 0.0010, 0.0006],
          [0.0012, 0.0012, 0.0012,  ..., 0.0015, 0.0009, 0.0005],
          ...,
          [0.0011, 0.0009, 0.0013,  ..., 0.0013, 0.0009, 0.0008],
          [0.0011, 0.0010, 0.0007,  ..., 0.0012, 0.0012, 0.0007],
          [0.0007, 0.0007, 0.0008,  ..., 0.0010, 0.0007, 0.0007]]],


        [[[0.0014, 0.0008, 0.0008,  ..., 0.0010, 0.0010, 0.0009],
          [0.0013, 0.0008, 0.0009,  ..., 0.0011, 0.0009, 0.0009],
          [0.0008, 0.0008, 0.0009,  ..., 0.0009, 0.0010, 0.0009],
          ...,
          [0.0011, 0.0011, 0.0011,  ..., 0.0010, 0.0010, 0.0011],
          [0.0008, 0.0008, 0.0011,  ..., 0.0011, 0.0009, 0.0008],
          [0.0006, 0.0013, 0.0012,  ..., 0.0008, 0.0008, 0.0007]],

         [[0.0014, 0.0009, 0.0010,  ..., 0.0009, 0.0008, 0.0008],
          [0.0007, 0.0009, 0.0010,  ..., 0.0008, 0.0008, 0.0008],
          [0.0007, 0.0000, 0.0010,  ..., 0.0009, 0.0009, 0.0008],
          ...,
          [0.0011, 0.0009, 0.0011,  ..., 0.0010, 0.0011, 0.0012],
          [0.0008, 0.0007, 0.0012,  ..., 0.0012, 0.0012, 0.0007],
          [0.0014, 0.0013, 0.0013,  ..., 0.0013, 0.0007, 0.0006]],

         [[0.0011, 0.0011, 0.0009,  ..., 0.0012, 0.0012, 0.0012],
          [0.0010, 0.0011, 0.0012,  ..., 0.0013, 0.0008, 0.0012],
          [0.0010, 0.0011, 0.0012,  ..., 0.0008, 0.0008, 0.0008],
          ...,
          [0.0008, 0.0007, 0.0007,  ..., 0.0012, 0.0013, 0.0013],
          [0.0006, 0.0005, 0.0014,  ..., 0.0013, 0.0014, 0.0006],
          [0.0006, 0.0006, 0.0014,  ..., 0.0006, 0.0006, 0.0006]]]],
       device=&#39;cuda:0&#39;, grad_fn=&lt;MulBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[[0.0007, 0.0007, 0.0007, 0.0013, 0.0013, 0.0012, 0.0007],
         [0.0012, 0.0012, 0.0008, 0.0008, 0.0007, 0.0007, 0.0012],
         [0.0008, 0.0012, 0.0012, 0.0013, 0.0013, 0.0012, 0.0012],
         [0.0012, 0.0009, 0.0009, 0.0008, 0.0008, 0.0008, 0.0012],
         [0.0009, 0.0011, 0.0010, 0.0009, 0.0007, 0.0008, 0.0008],
         [0.0011, 0.0011, 0.0010, 0.0010, 0.0012, 0.0011, 0.0012],
         [0.0010, 0.0009, 0.0009, 0.0010, 0.0008, 0.0010, 0.0008]],

        [[0.0006, 0.0006, 0.0006, 0.0014, 0.0014, 0.0013, 0.0006],
         [0.0013, 0.0012, 0.0007, 0.0007, 0.0006, 0.0006, 0.0007],
         [0.0007, 0.0013, 0.0013, 0.0013, 0.0014, 0.0014, 0.0013],
         [0.0008, 0.0008, 0.0008, 0.0000, 0.0007, 0.0007, 0.0012],
         [0.0009, 0.0009, 0.0010, 0.0008, 0.0006, 0.0006, 0.0007],
         [0.0011, 0.0010, 0.0009, 0.0011, 0.0000, 0.0012, 0.0013],
         [0.0011, 0.0010, 0.0009, 0.0010, 0.0008, 0.0009, 0.0008]],

        [[0.0018, 0.0003, 0.0016, 0.0016, 0.0016, 0.0015, 0.0004],
         [0.0017, 0.0004, 0.0004, 0.0004, 0.0004, 0.0004, 0.0004],
         [0.0016, 0.0016, 0.0016, 0.0016, 0.0016, 0.0016, 0.0015],
         [0.0016, 0.0005, 0.0005, 0.0005, 0.0004, 0.0016, 0.0015],
         [0.0006, 0.0014, 0.0013, 0.0014, 0.0003, 0.0004, 0.0005],
         [0.0014, 0.0007, 0.0008, 0.0014, 0.0016, 0.0015, 0.0015],
         [0.0013, 0.0012, 0.0007, 0.0008, 0.0005, 0.0006, 0.0006]]],
       device=&#39;cuda:0&#39;, grad_fn=&lt;SelectBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-0.0010, device=&#39;cuda:0&#39;, grad_fn=&lt;MinBackward1&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">granularize</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0009, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0011, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0011, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0011, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0011, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0011, 0.0011,
        0.0010], device=&#39;cuda:0&#39;, grad_fn=&lt;SqueezeBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">granularize</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">granularize</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">global_scs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span> <span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(True, device=&#39;cuda:0&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">min_value</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        
        <span class="c1">#print(large_final.get_scores(m, large_final(m), &#39;filter&#39;, large_final.min_value).squeeze())</span>
        <span class="c1">#if updating_magnitude_increase(m).view(-1)[updating_magnitude_increase(m).argmin()]&lt;min_value: min_value=updating_magnitude_increase(m).view(-1)[updating_magnitude_increase(m).argmin()]</span>
        <span class="c1">#print(updating_magnitude_increase(m))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2
8
11
14
17
21
24
27
30
33
37
40
43
46
49
53
56
59
62
65
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([0.0007, 0.0007, 0.0007,  ..., 0.0008, 0.0006, 0.0006], device=&#39;cuda:0&#39;,
       requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span><span class="p">[</span><span class="mi">800</span><span class="p">:</span><span class="mi">1200</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([0.0011, 0.0007, 0.0006, 0.0005, 0.0006, 0.0007, 0.0010, 0.0010, 0.0009,
        0.0006, 0.0005, 0.0006, 0.0007, 0.0009, 0.0009, 0.0010, 0.0007, 0.0015,
        0.0006, 0.0012, 0.0009, 0.0009, 0.0012, 0.0007, 0.0005, 0.0007, 0.0012,
        0.0010, 0.0011, 0.0012, 0.0014, 0.0005, 0.0007, 0.0011, 0.0014, 0.0015,
        0.0015, 0.0004, 0.0017, 0.0018, 0.0009, 0.0013, 0.0014, 0.0004, 0.0004,
        0.0004, 0.0004, 0.0007, 0.0011, 0.0013, 0.0005, 0.0004, 0.0003, 0.0004,
        0.0009, 0.0012, 0.0013, 0.0014, 0.0003, 0.0004, 0.0004, 0.0009, 0.0011,
        0.0011, 0.0013, 0.0005, 0.0004, 0.0005, 0.0010, 0.0011, 0.0012, 0.0014,
        0.0005, 0.0005, 0.0006, 0.0011, 0.0012, 0.0013, 0.0013, 0.0005, 0.0005,
        0.0006, 0.0007, 0.0009, 0.0010, 0.0012, 0.0012, 0.0013, 0.0013, 0.0006,
        0.0008, 0.0010, 0.0012, 0.0013, 0.0013, 0.0013, 0.0005, 0.0008, 0.0010,
        0.0007, 0.0005, 0.0006, 0.0014, 0.0005, 0.0012, 0.0010, 0.0009, 0.0008,
        0.0006, 0.0014, 0.0004, 0.0006, 0.0010, 0.0010, 0.0009, 0.0007, 0.0006,
        0.0003, 0.0005, 0.0014, 0.0011, 0.0009, 0.0004, 0.0016, 0.0002, 0.0004,
        0.0005, 0.0009, 0.0006, 0.0002, 0.0017, 0.0013, 0.0011, 0.0010, 0.0008,
        0.0007, 0.0006, 0.0006, 0.0014, 0.0012, 0.0011, 0.0012, 0.0014, 0.0014,
        0.0006, 0.0015, 0.0012, 0.0011, 0.0014, 0.0017, 0.0016, 0.0015, 0.0015,
        0.0009, 0.0012, 0.0013, 0.0014, 0.0016, 0.0016, 0.0016, 0.0006, 0.0012,
        0.0000, 0.0000, 0.0013, 0.0015, 0.0018, 0.0004, 0.0005, 0.0010, 0.0013,
        0.0018, 0.0017, 0.0018, 0.0017, 0.0003, 0.0013, 0.0017, 0.0019, 0.0019,
        0.0006, 0.0008, 0.0010, 0.0014, 0.0015, 0.0016, 0.0015, 0.0005, 0.0008,
        0.0010, 0.0007, 0.0004, 0.0005, 0.0005, 0.0005, 0.0011, 0.0007, 0.0004,
        0.0001, 0.0002, 0.0004, 0.0004, 0.0010, 0.0006, 0.0004, 0.0004, 0.0002,
        0.0003, 0.0003, 0.0014, 0.0007, 0.0005, 0.0007, 0.0006, 0.0005, 0.0002,
        0.0017, 0.0016, 0.0011, 0.0007, 0.0003, 0.0003, 0.0002, 0.0018, 0.0018,
        0.0009, 0.0000, 0.0002, 0.0002, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010,
        0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0010, 0.0005, 0.0014,
        0.0008, 0.0012, 0.0009, 0.0011, 0.0009, 0.0004, 0.0014, 0.0013, 0.0013,
        0.0008, 0.0011, 0.0009, 0.0004, 0.0006, 0.0014, 0.0006, 0.0009, 0.0010,
        0.0009, 0.0015, 0.0007, 0.0014], device=&#39;cuda:0&#39;,
       grad_fn=&lt;SliceBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">updating_magnitude_increase</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of weight until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
    <div>
      <progress value='0' class='' max='5' style='width:300px; height:20px; vertical-align: middle;'></progress>
      0.00% [0/5 00:00<00:00]
    </div>
    
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table><p>

    <div>
      <progress value='6' class='' max='92' style='width:300px; height:20px; vertical-align: middle;'></progress>
      6.52% [6/92 00:04<01:06 1.0906]
    </div>
    </div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([0., 0., 0.,  ..., 0., 0., 0.], device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
tensor([ 0.0010,  0.0010,  0.0010,  ..., -0.0010, -0.0010, -0.0010],
       device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
tensor([-0.0002, -0.0005, -0.0002,  ..., -0.0007, -0.0008, -0.0007],
       device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
tensor([ 5.0217e-06, -4.7387e-05,  1.6059e-04,  ..., -5.1428e-04,
        -5.0568e-04, -3.9404e-04], device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
tensor([-0.0005, -0.0006, -0.0005,  ..., -0.0005, -0.0006, -0.0004],
       device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
tensor([-0.0002, -0.0002, -0.0001,  ..., -0.0005, -0.0006, -0.0004],
       device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
tensor([-0.0003, -0.0003, -0.0003,  ..., -0.0002, -0.0004, -0.0004],
       device=&#39;cuda:0&#39;, grad_fn=&lt;CatBackward0&gt;)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
KeyboardInterrupt

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span> <span class="o">=</span> <span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sc</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[[[ 0.0000e+00,  3.1665e-08,  3.8650e-08,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  2.2352e-08,  ...,  0.0000e+00,
            1.4901e-08,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        [[[ 2.1420e-08,  1.9092e-08,  0.0000e+00,  ...,  1.8626e-08,
            2.2352e-08,  2.2352e-08],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 1.4901e-08,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            1.4901e-08,  1.4901e-08],
          [ 0.0000e+00,  0.0000e+00,  1.1176e-08,  ...,  1.3039e-08,
            1.6764e-08,  1.8626e-08],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 7.4506e-09,  5.5879e-09,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 7.4506e-09,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            1.4901e-08,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  7.4506e-09,
            1.4901e-08,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        ...,


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            2.6077e-08,  1.1176e-08],
          [ 1.8626e-09,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 2.2352e-08,  1.9558e-08,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 4.6566e-08,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 5.7742e-08,  5.8673e-08,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 5.9605e-08,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 9.3132e-08,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            3.3528e-08,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  3.7253e-09,  0.0000e+00,  ...,  0.0000e+00,
            3.3760e-09,  1.7462e-09],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            7.4506e-09,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  2.7940e-09,  0.0000e+00,  ...,  2.0955e-09,
            0.0000e+00,  1.8626e-09],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00, -1.3970e-09],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            7.4506e-09,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            5.5879e-09,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  3.7253e-09,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]]], device=&#39;cuda:0&#39;,
       grad_fn=&lt;SubBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[[[-0.0000e+00, -9.1996e-03, -4.4083e-03,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -1.1251e-01,  ..., -2.7214e-01,
           -1.2951e-01, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [-0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
            0.0000e+00, -0.0000e+00]],

         [[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ...,  0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ...,  0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]]],


        [[[-4.8550e-03, -4.2851e-03, -0.0000e+00,  ..., -3.7784e-02,
           -2.6483e-02, -4.9857e-02],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-1.1106e-02, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -1.4430e-01,
           -1.1385e-01, -5.1759e-02],
          [-0.0000e+00, -0.0000e+00, -1.5829e-02,  ..., -2.3354e-02,
           -2.6224e-02, -3.2349e-02],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]],

         [[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-6.0392e-02, -2.4560e-02, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [-1.1325e-01, -0.0000e+00,  0.0000e+00,  ..., -2.8661e-01,
           -2.1487e-01, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -9.5230e-02,
           -7.0820e-02, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]],

         [[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]]],


        [[[-7.0793e-08, -6.4276e-08, -7.3772e-08,  ..., -9.7954e-08,
           -1.0900e-07, -8.3382e-08],
          [-6.1097e-09,  2.0603e-09, -8.0885e-09,  ..., -4.9817e-08,
           -4.3815e-08, -3.0523e-09],
          [ 7.1919e-08,  7.5581e-08,  5.9255e-08,  ..., -9.7464e-09,
           -1.0946e-09,  4.2423e-08],
          ...,
          [ 9.5844e-08,  1.0034e-07,  7.9780e-08,  ..., -1.7483e-08,
           -4.7644e-08, -1.3259e-08],
          [ 1.2898e-07,  1.4755e-07,  1.7468e-07,  ...,  1.3226e-07,
            1.0623e-07,  9.3272e-08],
          [ 1.2553e-07,  1.3638e-07,  1.8422e-07,  ...,  2.1389e-07,
            1.7701e-07,  1.7158e-07]],

         [[-1.2684e-07, -9.6094e-08, -1.0367e-07,  ..., -1.1803e-07,
           -1.3303e-07, -1.0815e-07],
          [-5.7386e-08, -2.5043e-08, -3.0101e-08,  ..., -7.2888e-08,
           -6.6991e-08, -2.2564e-08],
          [ 2.1803e-08,  4.8586e-08,  3.1207e-08,  ..., -1.8685e-08,
           -7.9554e-09,  3.9732e-08],
          ...,
          [ 5.5987e-08,  7.5491e-08,  4.4475e-08,  ..., -4.4107e-08,
           -5.9902e-08, -1.8239e-08],
          [ 7.7578e-08,  9.8302e-08,  1.0450e-07,  ...,  6.3242e-08,
            4.1761e-08,  4.5880e-08],
          [ 5.9806e-08,  7.0973e-08,  9.0395e-08,  ...,  1.1649e-07,
            8.7510e-08,  9.8791e-08]],

         [[-4.3790e-08,  1.3264e-08,  7.8239e-09,  ..., -5.8777e-09,
           -2.6205e-08, -1.5642e-08],
          [ 4.1681e-08,  1.0773e-07,  1.0941e-07,  ...,  7.6368e-08,
            7.1417e-08,  9.7569e-08],
          [ 1.0431e-07,  1.6578e-07,  1.5926e-07,  ...,  1.3511e-07,
            1.3481e-07,  1.6441e-07],
          ...,
          [ 9.8718e-08,  1.5065e-07,  1.2541e-07,  ...,  6.8284e-08,
            6.8350e-08,  1.1362e-07],
          [ 9.1392e-08,  1.3570e-07,  1.3787e-07,  ...,  1.1673e-07,
            1.1717e-07,  1.4387e-07],
          [ 6.2154e-08,  8.8143e-08,  1.0452e-07,  ...,  1.3934e-07,
            1.3326e-07,  1.5837e-07]]],


        ...,


        [[[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]],

         [[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          ...,
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]],

         [[ 0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -4.1103e-02, -5.4732e-02],
          [-3.1011e-02, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-4.2861e-02, -8.1197e-03, -0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [-8.1318e-03, -0.0000e+00, -0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-3.0157e-02, -1.1246e-02, -0.0000e+00,  ..., -0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [-1.8279e-02, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        [[[-0.0000e+00, -0.0000e+00, -0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00, -0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00,  0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00],
          [-0.0000e+00, -0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
           -0.0000e+00, -0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00, -0.0000e+00,  ..., -0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 5.9157e-03,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            1.7233e-02,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]],


        [[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00, -0.0000e+00],
          [-0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00, -0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  3.1678e-02,  0.0000e+00,  ...,  0.0000e+00,
            1.1399e-03,  4.9293e-04],
          [-0.0000e+00,  0.0000e+00,  1.4514e-01,  ...,  0.0000e+00,
            0.0000e+00, -0.0000e+00],
          [-0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00, -0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  4.0631e-01,
            2.6102e-01,  1.3537e-01],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            8.9127e-02,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[-0.0000e+00,  1.1473e-02,  0.0000e+00,  ...,  2.0317e-03,
            0.0000e+00,  1.3542e-02],
          [-0.0000e+00,  4.4105e-02,  5.8867e-02,  ...,  1.2212e-02,
            0.0000e+00,  3.9528e-03],
          [-0.0000e+00,  1.2382e-01,  4.1229e-02,  ...,  0.0000e+00,
            0.0000e+00, -0.0000e+00],
          ...,
          [-0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  2.2744e-01,
            1.1968e-01,  7.2456e-02],
          [-0.0000e+00,  0.0000e+00,  8.1858e-02,  ...,  1.5512e-01,
            2.0697e-02,  0.0000e+00],
          [-0.0000e+00,  0.0000e+00,  3.2302e-02,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]]]], device=&#39;cuda:0&#39;, requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[[[0., 1., 1.,  ..., 0., 0., 0.],
          [0., 0., 1.,  ..., 1., 1., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]]],


        [[[1., 1., 0.,  ..., 1., 1., 1.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [1., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 1., 1., 1.],
          [0., 0., 1.,  ..., 1., 1., 1.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [1., 1., 0.,  ..., 0., 0., 0.],
          ...,
          [1., 0., 0.,  ..., 1., 1., 0.],
          [0., 0., 0.,  ..., 1., 1., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]]],


        [[[1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          ...,
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.]],

         [[1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          ...,
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.]],

         [[1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          ...,
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.],
          [1., 1., 1.,  ..., 1., 1., 1.]]],


        ...,


        [[[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 1., 1.],
          [1., 0., 0.,  ..., 0., 0., 0.],
          [1., 1., 0.,  ..., 0., 0., 0.],
          ...,
          [1., 0., 0.,  ..., 0., 0., 0.],
          [1., 1., 0.,  ..., 0., 0., 0.],
          [1., 0., 0.,  ..., 0., 0., 0.]]],


        [[[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [1., 0., 0.,  ..., 0., 1., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]]],


        [[[0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 1., 0.,  ..., 0., 1., 1.],
          [0., 0., 1.,  ..., 0., 0., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 1., 1., 1.],
          [0., 0., 0.,  ..., 0., 1., 0.],
          [0., 0., 0.,  ..., 0., 0., 0.]],

         [[0., 1., 0.,  ..., 1., 0., 1.],
          [0., 1., 1.,  ..., 1., 0., 1.],
          [0., 1., 1.,  ..., 0., 0., 0.],
          ...,
          [0., 0., 0.,  ..., 1., 1., 1.],
          [0., 0., 1.,  ..., 1., 1., 0.],
          [0., 0., 1.,  ..., 0., 0., 0.]]]], device=&#39;cuda:0&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">debug</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&gt; <span class="ansi-green-fg">/tmp/ipykernel_1952159/3353689575.py</span>(27)<span class="ansi-cyan-fg">granularize</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">     25 </span><span class="ansi-red-fg">            </span>dim <span class="ansi-blue-fg">=</span> granularities<span class="ansi-blue-fg">[</span>m<span class="ansi-blue-fg">.</span>__class__<span class="ansi-blue-fg">.</span>__name__<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span>g<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">     26 </span><span class="ansi-red-fg">            </span><span class="ansi-red-fg">#if hasattr(m, &#39;_mask&#39;) == False: m.register_buffer(&#34;_mask&#34;, torch.ones_like(scores[None].mean(dim=dim, keepdim=True).squeeze(0))) # Put the mask into a buffer</span>
<span class="ansi-green-fg">---&gt; 27 </span><span class="ansi-red-fg">            </span>scores <span class="ansi-blue-fg">=</span> scores<span class="ansi-blue-fg">[</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>mean<span class="ansi-blue-fg">(</span>dim<span class="ansi-blue-fg">=</span>dim<span class="ansi-blue-fg">,</span> keepdim<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>squeeze<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">     28 </span><span class="ansi-red-fg">        </span><span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">raise</span> NameError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Invalid Granularity&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">     29 </span><span class="ansi-red-fg">        </span><span class="ansi-green-fg">return</span> scores

ipdb&gt; scores.shape
torch.Size([11166912])
ipdb&gt; quit
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SparsifyCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">lth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rewind_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reset_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_tickets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pruning of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="si">}</span><span class="s1"> until a sparsity of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">,</span> <span class="s1">&#39;You must rewind to an epoch before the start of the pruning process&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span> <span class="o">=</span> <span class="n">Sparsifier</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Weights at epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Intermediate Ticket&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resetting Weights to their epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="si">}</span><span class="s1"> values&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">after_pruned</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_apply_masks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">after_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sparsity_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%0.2f&quot;</span><span class="o">%</span><span class="k">sp</span>) for sp in self.current_sparsity]
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sparsity at the end of epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sparsity_str</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Final Ticket&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final Sparsity: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">current_sparsity</span><span class="si">:}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_end</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">()</span>
        <span class="c1">#self.sparsifier._clean_buffers()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">print_sparsity</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>
<span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
        <span class="p">[[</span> <span class="mf">0.421</span><span class="p">,</span>  <span class="mf">0.398</span><span class="p">,</span>  <span class="mf">0.056</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.164</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.456</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.131</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.344</span><span class="p">,</span>  <span class="mf">0.335</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.400</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
        <span class="p">[[</span> <span class="mf">0.299</span><span class="p">,</span>  <span class="mf">0.512</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.397</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.050</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.472</span><span class="p">,</span>  <span class="mf">0.561</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.028</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.224</span><span class="p">,</span>  <span class="mf">0.427</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span> <span class="o">=</span> <span class="n">Sparsifier</span><span class="p">(</span><span class="n">mmm</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">updating_magnitude_increase</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>
<span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
        <span class="p">[[</span> <span class="mf">0.431</span><span class="p">,</span>  <span class="mf">0.399</span><span class="p">,</span>  <span class="mf">0.036</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.114</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.426</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.172</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.348</span><span class="p">,</span>  <span class="mf">0.305</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.456</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
        <span class="p">[[</span> <span class="mf">0.212</span><span class="p">,</span>  <span class="mf">0.535</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.398</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.067</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.421</span><span class="p">,</span>  <span class="mf">0.456</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.045</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.287</span><span class="p">,</span>  <span class="mf">0.356</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-0.0334, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-0.0008, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>updating_magnitude_increase.__call__<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.0117, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.0003, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mmm</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
<span class="n">global_scores</span> <span class="o">=</span> <span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">))</span>
                
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">min_value</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-4.8099, grad_fn=&lt;SelectBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">min_value</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(4.8364, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">min_value</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-4.8099, grad_fn=&lt;SelectBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">updating_magnitude_increase</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">updating_magnitude_increase</span><span class="o">.</span><span class="n">min_value</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(4.8095, grad_fn=&lt;MeanBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[-0.4697, -0.0000,  0.0000,  0.6964, -0.0000, -0.0000,  0.4197,  0.6107,
         -0.3471, -1.5264, -0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
         -0.0000,  0.0000, -0.0000,  0.0000, -0.7765,  0.0000,  0.3007,  0.0000,
          1.3610,  0.0000, -0.0000, -1.0565,  2.1248,  0.6461],
        [ 1.3334,  0.0000, -0.0000, -0.7524, -0.0000,  0.0000,  2.1995, -1.8947,
          0.0000, -0.0000,  1.3457,  0.5020, -0.0000,  0.0000, -0.5550,  0.0000,
          0.7765,  1.5074,  0.0000,  0.7520, -0.8449, -0.0000, -0.0000,  1.1098,
         -0.0000, -1.3247,  0.3156, -0.8737,  2.6677,  0.0000],
        [-1.1004, -0.0000,  0.0000,  0.0000, -0.9998,  0.0000, -1.7682, -0.5072,
         -0.0000,  0.0000, -1.1983, -0.5300, -0.1178,  0.0000,  1.9009,  0.0000,
         -1.1917,  0.1676, -2.0444,  0.0000,  1.2305,  0.0000, -0.2910, -0.0000,
          0.0000,  0.0000,  1.6175, -1.0137, -0.0000,  0.0000],
        [ 0.0000, -0.0000,  2.1317,  0.0000, -0.0000, -0.0000,  0.0000,  0.0000,
          0.6983, -0.0000,  0.0000,  1.3517, -0.0000, -0.0000, -0.0000,  0.0000,
         -1.1758,  0.0000, -0.0000,  0.0000,  0.0000,  0.0000,  1.9039,  1.8416,
         -1.8862, -0.0000,  0.0000,  1.0628,  1.3996, -0.0000],
        [-1.7224,  0.0000, -0.0000,  0.4172,  0.0000,  1.4383,  0.9212,  0.0000,
         -4.0557, -0.9632, -0.0000,  0.0000,  0.1785,  1.1216,  0.0000,  0.4738,
         -0.2778,  0.0000, -1.4880, -0.0000, -0.0000, -0.4614,  0.0000, -1.1963,
         -0.6461, -0.9679,  0.4609,  2.0274, -0.0000,  0.5464],
        [-0.0000, -1.0287, -0.0000,  0.0000, -1.1861, -0.0000,  0.0000, -0.0000,
          1.3118,  1.0544, -0.3401, -0.0000, -0.4149, -0.0000, -0.0000,  0.0000,
         -0.0000, -1.7844, -0.0000, -1.1136, -0.0000,  0.0000,  0.0000, -0.8604,
         -2.2147, -0.8733, -0.0000,  0.0000, -1.4399, -0.6658],
        [-1.1911,  1.1144, -1.6733,  1.8671,  2.7911, -1.0089,  0.0000, -0.0000,
          0.6511, -0.7973,  0.3811, -0.0000, -0.3755, -0.0000, -1.3389,  0.0000,
         -0.0000, -0.0000,  0.0000, -0.0000, -0.0000,  0.0000, -0.0000,  1.2961,
          1.4071,  1.4808,  0.7312,  0.0000, -1.0309, -1.7718],
        [ 0.0000, -0.0000, -0.4198, -0.0000, -0.0000, -0.0000, -0.0000,  1.6534,
         -0.0000,  0.5711,  0.0000, -0.0000, -0.0000,  0.8588, -0.8003,  0.7455,
          0.0000, -0.6631, -1.9123,  1.5362,  0.0000, -0.0000,  0.0000, -0.0000,
          2.4530, -0.6909,  0.0000,  0.0000,  0.0000, -0.0000],
        [-2.3368,  0.0000, -0.4693, -0.0000, -0.0000,  0.0000,  0.0000, -0.0000,
         -0.5719,  0.0000, -0.0000,  0.4853,  0.0000, -2.0872, -0.0000,  0.0000,
          0.0000, -1.1446, -1.0138,  0.0000, -0.0000, -0.0000, -1.9052,  0.3071,
         -0.0000, -0.0000,  1.5891, -1.5744, -0.3440,  0.0000],
        [ 2.8317,  0.0000, -1.6325,  0.0000, -0.0000, -0.0000, -0.2990,  1.6706,
         -0.0000,  2.4660,  0.6963,  1.1858,  0.3070,  0.0000,  0.0000,  1.1636,
         -0.0000,  0.0000,  0.0000, -0.0000,  0.0000, -1.8598, -0.0000, -0.0000,
          0.7630, -0.7048, -0.2939, -0.0000, -0.0000,  1.0744],
        [ 0.7770, -1.7871,  0.0000,  0.0000,  0.0000, -0.5985, -0.0000,  1.4921,
          0.0000,  0.0000, -0.1751, -0.0000,  0.8796,  0.7243, -2.2937, -0.0000,
          0.0000, -1.0126,  1.3886, -1.0761, -2.1231, -1.7882,  0.0000, -0.0000,
         -0.0000, -0.0000,  1.3518, -0.0000, -0.0000, -0.0000],
        [-1.3437,  0.5383, -0.6913, -0.0000,  0.7758,  0.0000, -0.0000,  1.0919,
          1.2038,  0.0000, -0.0000,  1.6652,  0.0000,  0.0000, -0.5265, -1.1390,
          0.0000, -0.0000,  1.5858, -0.5444,  0.0000,  0.0000, -0.0000,  1.0638,
          1.3580, -0.0000, -0.0000, -0.0000, -0.5559,  0.0000],
        [ 0.0000, -2.2599, -0.0000,  0.0000, -1.0718, -0.0000, -1.3622, -0.0000,
         -0.0000,  1.4162,  0.0000, -0.0000,  0.0000, -1.4348, -0.0000, -1.1684,
         -2.0178,  1.7049,  0.0000,  1.5161, -0.2162,  1.5940,  0.7751, -2.7666,
          0.0000, -2.0388,  1.4220,  0.4973, -0.6650, -0.0000],
        [-1.0671, -0.3545, -0.0000, -0.0000, -0.0000, -0.0000,  0.0000,  0.9151,
         -0.0000,  0.0000, -0.4876,  2.1664, -0.7885, -0.0000,  0.0000,  0.0000,
         -0.0000,  0.0000, -1.2401, -0.0000, -0.1766,  1.2207, -0.7934, -0.0000,
          2.7660,  0.0000, -0.4780, -1.3265, -0.9518, -0.0000],
        [ 1.0592,  0.0000,  0.5933,  0.0000, -0.7153,  2.5650, -0.9966, -0.0000,
         -0.7905,  0.0000, -0.0000, -1.1730, -0.0000,  0.0000,  0.0000, -0.0000,
          1.4408, -0.0000,  1.0600,  0.0000, -0.0000, -0.0000, -0.0000,  0.0000,
         -0.2164, -0.0000,  0.7504, -0.0000,  0.1538, -2.4244],
        [-1.7428,  0.7574, -0.0000,  1.4356, -0.0000, -0.0000,  0.0000,  0.0000,
          0.0000,  0.0000,  0.0000, -1.0921,  0.6738,  0.0000, -1.1633, -0.0000,
          0.0000, -0.0000, -1.4767, -1.1387,  0.0000, -0.0000, -0.4164, -0.7833,
          0.0000, -0.0000, -0.3589, -0.0000,  0.6142,  0.0000],
        [ 0.0000,  0.0000,  0.0000,  1.2298, -0.7466,  1.7485,  0.4276, -2.8522,
         -0.0000,  0.7918,  1.2715,  0.0000, -0.0000, -0.0000,  0.0000,  0.0000,
         -1.0455,  0.7355, -1.0363,  1.2118, -0.8099,  1.0770, -1.9903,  2.3046,
         -1.3997, -0.2232, -1.2704,  0.0000,  0.9377,  0.2910],
        [ 0.0000,  1.0140, -0.0000, -1.6978,  1.6673,  0.3279,  0.0000,  0.8625,
         -1.3830, -0.0000, -0.7740, -0.7179,  0.2901,  0.0000, -0.0000, -0.0000,
          0.0000, -0.0000,  0.0000,  0.0000,  0.0000, -1.4254,  2.4915,  2.4178,
         -0.0000,  0.0000, -0.0000, -0.4720,  0.0000,  0.9163],
        [ 0.8333,  0.0000,  0.0000, -0.0000,  0.5730,  1.2512, -0.0000, -0.0786,
         -0.0000, -0.0000,  1.2939, -1.5655,  0.0000, -0.0000, -0.0000, -0.0000,
          0.8519,  1.0708,  0.0000,  1.1720, -0.8262, -0.9850,  1.3785,  0.0000,
          0.0000, -0.0000,  0.0000, -0.0000,  0.8973, -0.0000],
        [-0.0000, -2.0345, -0.4941, -0.2799,  0.0000, -0.0000, -1.1654,  0.0000,
          0.0000,  0.0000,  0.0000,  1.1161,  1.6155,  0.9361,  1.0208,  0.0000,
          0.0000,  1.8135, -1.3932, -0.0000,  0.0000, -0.0000,  1.1717,  0.9664,
          0.0000,  1.1022,  0.4991, -1.6445, -1.3458, -0.0000],
        [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.4807,  0.0000,  1.8799,
         -0.0000,  1.6223, -0.5247,  0.0000, -0.0000,  0.4769, -0.3047, -0.8768,
         -1.1120, -1.4647,  2.7974,  2.2982, -0.0000, -2.3688, -0.0000, -2.0119,
         -2.1981, -0.8121, -0.0000,  0.0000,  0.9923,  0.3450],
        [-0.0000,  2.7514, -0.0000,  0.9442,  0.0000,  1.5887,  0.0000, -0.0000,
         -0.0000, -0.0000, -0.0000, -0.0000,  2.5753, -0.0000,  0.8475,  0.0000,
          1.1907, -1.2603, -1.3330, -0.0000,  0.0000,  0.0000,  0.2910, -1.2485,
         -0.0000,  1.7944,  0.0000, -0.4205, -0.0000, -0.0000],
        [ 2.7456,  0.0000,  1.3690, -0.0000,  0.9224, -0.0000, -0.4663,  0.9413,
          0.0000, -1.5284,  0.0000, -0.0000, -0.3151, -0.4256,  0.0000, -0.5944,
          0.0000,  0.9653,  1.1356, -1.0759, -0.4597,  0.4099, -1.7619, -0.0000,
         -0.0000,  0.9033, -0.1668,  1.6416, -0.0000, -1.0526],
        [-0.0000,  0.0000, -0.0000,  2.3039,  0.0000,  0.0000, -0.0000, -0.0000,
         -0.0000, -0.0000,  0.8914, -0.0000, -2.4315,  0.0000,  0.0000, -0.0000,
         -0.9459, -2.2884,  0.5098, -0.8177, -0.0000, -0.0000, -0.9245, -0.0000,
          1.4152,  0.2603, -0.5356, -0.0000, -4.0684, -1.9600],
        [-0.0000, -0.0000,  0.0000,  2.2072, -2.6049, -0.0000,  0.2980,  1.8473,
         -1.7405, -0.0000, -0.9643,  0.0000,  1.2898, -0.0925, -0.8666, -0.9252,
         -1.5343,  1.3880, -0.4778,  0.9656, -0.0000,  0.8843,  1.2774,  0.0000,
         -0.0000,  0.0000,  0.0000,  0.0000, -0.2223,  0.0000],
        [ 0.0000,  0.9122,  0.0000,  0.0000, -0.0000, -0.0000, -0.6227, -0.0000,
         -0.5466,  0.0000,  1.3575,  0.0000, -1.2804,  0.0000,  1.3495,  1.1257,
          0.7999,  0.0000, -0.7655, -0.0000,  0.0000,  0.0000,  0.0000, -0.0000,
          0.0000,  0.9295, -0.0000, -1.4763, -2.0517,  0.8248],
        [-0.0000, -0.0000, -0.5591,  1.4653, -1.9468, -0.0000, -0.0000,  1.6211,
          0.7414,  0.2067,  0.0000,  0.0000, -1.4623, -1.3966,  0.3445, -0.3798,
          0.3531,  0.9742, -2.7739, -0.2327, -0.7980, -1.3762, -1.5635,  0.0000,
          0.7634, -1.3027, -0.0000,  0.0000,  0.4137,  0.6250],
        [ 1.2535,  0.0000,  0.5963,  0.7589,  0.0000,  0.0000, -0.0000, -2.1696,
         -0.9564,  1.0425, -0.0000, -0.5696,  1.1524,  1.4433, -0.0000, -0.0000,
         -0.0000, -1.6302,  0.0000,  0.0000, -1.3254,  0.1585, -0.2137,  0.3994,
         -0.0000,  0.0000, -0.8294, -1.8059, -1.6328, -0.0000],
        [-1.3658,  0.0000,  0.5649,  1.3609, -0.2278,  0.7200, -0.1217,  0.9329,
          0.0000, -0.2575,  0.0000, -0.4812, -0.6969, -0.0000, -0.0000, -0.0000,
          0.0000,  0.8209, -0.0000,  0.8714,  0.4689,  0.0000,  0.0000,  0.0000,
         -0.0000, -0.6730, -0.6239,  0.0000,  0.8790, -0.6795],
        [ 0.3636, -0.0000, -0.0000, -0.5781,  0.4282, -0.0000, -0.7778,  1.1833,
         -0.0000,  1.5292, -2.2093,  0.0000, -0.0000, -0.0000,  1.5653,  0.3961,
         -1.0770, -0.0000, -0.0000,  0.0000,  0.0000,  1.0421, -0.0000, -0.0000,
          2.1614,  0.8494,  0.0000, -0.0000, -0.0000,  0.0000]],
       requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[ 0.0000,  0.5350, -0.3980],
        [ 0.0670, -0.0000,  0.0000],
        [-0.0450, -0.2870,  0.0000]], requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_old_weights</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[ 0.4310,  0.3990,  0.0000],
        [-0.0000, -0.0000, -0.1720],
        [ 0.3480,  0.0000, -0.4560]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_old_weights</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[ 0.0000,  0.5350, -0.3980],
        [ 0.0670, -0.0000,  0.0000],
        [-0.0450, -0.2870,  0.0000]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
        <span class="p">[[</span> <span class="mf">0.4112</span><span class="p">,</span>  <span class="mf">0.3787</span><span class="p">,</span>  <span class="mf">0.0563</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1742</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4459</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2345</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.4584</span><span class="p">,</span>  <span class="mf">0.3128</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7657</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
        <span class="p">[[</span> <span class="mf">0.1982</span><span class="p">,</span>  <span class="mf">0.4983</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2781</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0819</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2375</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0975</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1970</span><span class="p">,</span>  <span class="mf">0.2969</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_movement</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;weight&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[0.0198, 0.0203, 0.0563],
        [0.1742, 0.4459, 0.0625],
        [0.1104, 0.3128, 0.3097]], grad_fn=&lt;AbsBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">updating_movement</span><span class="p">(</span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;weight&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[0.1982, 0.0367, 0.1199],
        [0.0149, 0.2375, 0.0000],
        [0.0525, 0.0900, 0.2969]], grad_fn=&lt;AbsBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[1., 1., 0.],
        [0., 0., 1.],
        [1., 0., 1.]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[0., 1., 1.],
        [1., 0., 0.],
        [1., 1., 0.]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor(-0.1199, grad_fn=&lt;SelectBackward0&gt;)
tensor(-0.1199, grad_fn=&lt;SelectBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[ 0.4112,  0.0000,  0.0000],
        [-0.0000, -0.0000, -0.2345],
        [ 0.4584,  0.0000, -0.7657]], requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[ 0.0000,  0.0000, -0.0000],
        [ 0.0819, -0.0000,  0.0000],
        [-0.0975, -0.0000,  0.0000]], requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[1., 0., 0.],
        [0., 0., 1.],
        [1., 0., 1.]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[0., 0., 0.],
        [1., 0., 0.],
        [1., 0., 0.]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>

<span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
<span class="n">magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SparsifyCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">lth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rewind_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reset_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_tickets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pruning of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="si">}</span><span class="s1"> until a sparsity of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">start_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">,</span> <span class="s1">&#39;You must rewind to an epoch before the start of the pruning process&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span> <span class="o">=</span> <span class="n">Sparsifier</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving Weights at epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">before_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Intermediate Ticket&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sparsity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">pruned</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resetting Weights to their epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rewind_epoch</span><span class="si">}</span><span class="s1"> values&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">after_pruned</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_apply_masks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">after_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sparsity_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%0.2f&quot;</span><span class="o">%</span><span class="k">sp</span>) for sp in self.current_sparsity]
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sparsity at the end of epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sparsity_str</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">print_sparsity</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tickets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving Final Ticket&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;winning_ticket_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_sparsity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final Sparsity: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">current_sparsity</span><span class="si">:}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_end</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsifier</span><span class="o">.</span><span class="n">print_sparsity</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">large_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span>
<span class="n">movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">large_init_large_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="n">large_init</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#updating_movmag = Criteria(noop, needs_update=True, output_f=lambda x,y: torch.mul(x, torch.sub(x,y)))</span>
<span class="c1">#updating_movmag = Criteria(noop, needs_update=True, output_f=lambda x,y: torch.mul(x, torch.sub(y,x)))</span>
<span class="n">updating_movmag</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))))</span>
<span class="n">squared_final</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">)</span>
<span class="n">updating_movement2</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_magnitude_increase</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span>
<span class="n">updating_movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_movement</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="n">y</span><span class="p">)))</span>
<span class="n">updating_movmag</span> <span class="o">=</span> <span class="n">Criteria</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>

<span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">updating_magnitude_increase</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of weight until a sparsity of [50]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.761539</td>
      <td>0.571041</td>
      <td>0.826116</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.489818</td>
      <td>0.342061</td>
      <td>0.841678</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.336039</td>
      <td>0.350340</td>
      <td>0.866712</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.251031</td>
      <td>0.270618</td>
      <td>0.881597</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.182463</td>
      <td>0.228612</td>
      <td>0.903248</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.142317</td>
      <td>0.210487</td>
      <td>0.908660</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.115957</td>
      <td>0.198245</td>
      <td>0.926928</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.069680</td>
      <td>0.220449</td>
      <td>0.926928</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.047530</td>
      <td>0.228066</td>
      <td>0.921516</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.046027</td>
      <td>0.236840</td>
      <td>0.920162</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [1.22]%
Sparsity in Conv2d 2: 13.57%
Sparsity in Conv2d 8: 13.23%
Sparsity in Conv2d 11: 0.87%
Sparsity in Conv2d 14: 0.84%
Sparsity in Conv2d 17: 0.76%
Sparsity in Conv2d 21: 0.84%
Sparsity in Conv2d 24: 0.81%
Sparsity in Conv2d 27: 0.87%
Sparsity in Conv2d 30: 0.82%
Sparsity in Conv2d 33: 0.84%
Sparsity in Conv2d 37: 0.90%
Sparsity in Conv2d 40: 0.96%
Sparsity in Conv2d 43: 0.79%
Sparsity in Conv2d 46: 1.01%
Sparsity in Conv2d 49: 1.07%
Sparsity in Conv2d 53: 1.06%
Sparsity in Conv2d 56: 1.15%
Sparsity in Conv2d 59: 0.85%
Sparsity in Conv2d 62: 1.11%
Sparsity in Conv2d 65: 1.47%
Sparsity at the end of epoch 1: [4.77]%
Sparsity in Conv2d 2: 14.39%
Sparsity in Conv2d 8: 14.35%
Sparsity in Conv2d 11: 2.14%
Sparsity in Conv2d 14: 2.13%
Sparsity in Conv2d 17: 1.91%
Sparsity in Conv2d 21: 2.07%
Sparsity in Conv2d 24: 2.40%
Sparsity in Conv2d 27: 1.94%
Sparsity in Conv2d 30: 2.42%
Sparsity in Conv2d 33: 2.47%
Sparsity in Conv2d 37: 2.68%
Sparsity in Conv2d 40: 3.05%
Sparsity in Conv2d 43: 2.48%
Sparsity in Conv2d 46: 3.47%
Sparsity in Conv2d 49: 3.77%
Sparsity in Conv2d 53: 3.85%
Sparsity in Conv2d 56: 5.24%
Sparsity in Conv2d 59: 2.57%
Sparsity in Conv2d 62: 4.87%
Sparsity in Conv2d 65: 6.36%
Sparsity at the end of epoch 2: [10.31]%
Sparsity in Conv2d 2: 14.77%
Sparsity in Conv2d 8: 15.15%
Sparsity in Conv2d 11: 3.03%
Sparsity in Conv2d 14: 3.05%
Sparsity in Conv2d 17: 2.92%
Sparsity in Conv2d 21: 3.01%
Sparsity in Conv2d 24: 3.60%
Sparsity in Conv2d 27: 2.69%
Sparsity in Conv2d 30: 3.66%
Sparsity in Conv2d 33: 3.88%
Sparsity in Conv2d 37: 4.21%
Sparsity in Conv2d 40: 4.93%
Sparsity in Conv2d 43: 3.99%
Sparsity in Conv2d 46: 5.91%
Sparsity in Conv2d 49: 6.53%
Sparsity in Conv2d 53: 7.01%
Sparsity in Conv2d 56: 12.08%
Sparsity in Conv2d 59: 4.33%
Sparsity in Conv2d 62: 11.75%
Sparsity in Conv2d 65: 14.74%
Sparsity at the end of epoch 3: [17.27]%
Sparsity in Conv2d 2: 15.51%
Sparsity in Conv2d 8: 16.17%
Sparsity in Conv2d 11: 4.27%
Sparsity in Conv2d 14: 4.19%
Sparsity in Conv2d 17: 4.13%
Sparsity in Conv2d 21: 4.23%
Sparsity in Conv2d 24: 5.04%
Sparsity in Conv2d 27: 3.80%
Sparsity in Conv2d 30: 5.23%
Sparsity in Conv2d 33: 5.60%
Sparsity in Conv2d 37: 6.10%
Sparsity in Conv2d 40: 7.26%
Sparsity in Conv2d 43: 5.93%
Sparsity in Conv2d 46: 8.78%
Sparsity in Conv2d 49: 9.91%
Sparsity in Conv2d 53: 10.95%
Sparsity in Conv2d 56: 19.87%
Sparsity in Conv2d 59: 6.63%
Sparsity in Conv2d 62: 21.28%
Sparsity in Conv2d 65: 25.43%
Sparsity at the end of epoch 4: [25.0]%
Sparsity in Conv2d 2: 16.67%
Sparsity in Conv2d 8: 17.75%
Sparsity in Conv2d 11: 5.93%
Sparsity in Conv2d 14: 5.75%
Sparsity in Conv2d 17: 5.85%
Sparsity in Conv2d 21: 6.14%
Sparsity in Conv2d 24: 7.22%
Sparsity in Conv2d 27: 5.31%
Sparsity in Conv2d 30: 7.46%
Sparsity in Conv2d 33: 8.03%
Sparsity in Conv2d 37: 8.63%
Sparsity in Conv2d 40: 10.37%
Sparsity in Conv2d 43: 8.40%
Sparsity in Conv2d 46: 12.57%
Sparsity in Conv2d 49: 14.23%
Sparsity in Conv2d 53: 15.97%
Sparsity in Conv2d 56: 28.28%
Sparsity in Conv2d 59: 9.90%
Sparsity in Conv2d 62: 31.62%
Sparsity in Conv2d 65: 36.79%
Sparsity at the end of epoch 5: [32.73]%
Sparsity in Conv2d 2: 17.86%
Sparsity in Conv2d 8: 19.73%
Sparsity in Conv2d 11: 8.12%
Sparsity in Conv2d 14: 8.07%
Sparsity in Conv2d 17: 7.99%
Sparsity in Conv2d 21: 8.58%
Sparsity in Conv2d 24: 9.92%
Sparsity in Conv2d 27: 7.19%
Sparsity in Conv2d 30: 10.24%
Sparsity in Conv2d 33: 11.03%
Sparsity in Conv2d 37: 11.78%
Sparsity in Conv2d 40: 14.03%
Sparsity in Conv2d 43: 11.42%
Sparsity in Conv2d 46: 17.01%
Sparsity in Conv2d 49: 19.24%
Sparsity in Conv2d 53: 21.69%
Sparsity in Conv2d 56: 36.67%
Sparsity in Conv2d 59: 13.92%
Sparsity in Conv2d 62: 41.53%
Sparsity in Conv2d 65: 47.52%
Sparsity at the end of epoch 6: [39.69]%
Sparsity in Conv2d 2: 19.31%
Sparsity in Conv2d 8: 22.28%
Sparsity in Conv2d 11: 11.07%
Sparsity in Conv2d 14: 10.78%
Sparsity in Conv2d 17: 10.89%
Sparsity in Conv2d 21: 11.64%
Sparsity in Conv2d 24: 13.37%
Sparsity in Conv2d 27: 9.96%
Sparsity in Conv2d 30: 13.68%
Sparsity in Conv2d 33: 14.68%
Sparsity in Conv2d 37: 15.57%
Sparsity in Conv2d 40: 18.30%
Sparsity in Conv2d 43: 15.03%
Sparsity in Conv2d 46: 21.92%
Sparsity in Conv2d 49: 24.58%
Sparsity in Conv2d 53: 27.60%
Sparsity in Conv2d 56: 44.14%
Sparsity in Conv2d 59: 18.41%
Sparsity in Conv2d 62: 49.92%
Sparsity in Conv2d 65: 56.39%
Sparsity at the end of epoch 7: [45.23]%
Sparsity in Conv2d 2: 21.10%
Sparsity in Conv2d 8: 24.27%
Sparsity in Conv2d 11: 13.47%
Sparsity in Conv2d 14: 13.09%
Sparsity in Conv2d 17: 13.26%
Sparsity in Conv2d 21: 14.07%
Sparsity in Conv2d 24: 16.16%
Sparsity in Conv2d 27: 12.49%
Sparsity in Conv2d 30: 16.46%
Sparsity in Conv2d 33: 17.55%
Sparsity in Conv2d 37: 18.62%
Sparsity in Conv2d 40: 21.72%
Sparsity in Conv2d 43: 18.00%
Sparsity in Conv2d 46: 25.96%
Sparsity in Conv2d 49: 28.86%
Sparsity in Conv2d 53: 32.31%
Sparsity in Conv2d 56: 49.68%
Sparsity in Conv2d 59: 22.11%
Sparsity in Conv2d 62: 57.19%
Sparsity in Conv2d 65: 63.16%
Sparsity at the end of epoch 8: [48.78]%
Sparsity in Conv2d 2: 23.46%
Sparsity in Conv2d 8: 26.24%
Sparsity in Conv2d 11: 15.71%
Sparsity in Conv2d 14: 15.49%
Sparsity in Conv2d 17: 15.37%
Sparsity in Conv2d 21: 16.57%
Sparsity in Conv2d 24: 18.71%
Sparsity in Conv2d 27: 14.66%
Sparsity in Conv2d 30: 19.02%
Sparsity in Conv2d 33: 20.18%
Sparsity in Conv2d 37: 21.35%
Sparsity in Conv2d 40: 24.63%
Sparsity in Conv2d 43: 20.71%
Sparsity in Conv2d 46: 29.16%
Sparsity in Conv2d 49: 32.13%
Sparsity in Conv2d 53: 35.85%
Sparsity in Conv2d 56: 53.37%
Sparsity in Conv2d 59: 25.14%
Sparsity in Conv2d 62: 61.19%
Sparsity in Conv2d 65: 67.01%
Sparsity at the end of epoch 9: [50.0]%
Sparsity in Conv2d 2: 25.31%
Sparsity in Conv2d 8: 27.31%
Sparsity in Conv2d 11: 16.86%
Sparsity in Conv2d 14: 16.77%
Sparsity in Conv2d 17: 16.53%
Sparsity in Conv2d 21: 17.72%
Sparsity in Conv2d 24: 19.72%
Sparsity in Conv2d 27: 15.84%
Sparsity in Conv2d 30: 20.10%
Sparsity in Conv2d 33: 21.17%
Sparsity in Conv2d 37: 22.36%
Sparsity in Conv2d 40: 25.59%
Sparsity in Conv2d 43: 21.91%
Sparsity in Conv2d 46: 30.15%
Sparsity in Conv2d 49: 33.14%
Sparsity in Conv2d 53: 36.91%
Sparsity in Conv2d 56: 54.49%
Sparsity in Conv2d 59: 26.49%
Sparsity in Conv2d 62: 62.55%
Sparsity in Conv2d 65: 68.04%
Final Sparsity: [50.0]%
Sparsity in Conv2d 2: 25.31%
Sparsity in Conv2d 8: 27.31%
Sparsity in Conv2d 11: 16.86%
Sparsity in Conv2d 14: 16.77%
Sparsity in Conv2d 17: 16.53%
Sparsity in Conv2d 21: 17.72%
Sparsity in Conv2d 24: 19.72%
Sparsity in Conv2d 27: 15.84%
Sparsity in Conv2d 30: 20.10%
Sparsity in Conv2d 33: 21.17%
Sparsity in Conv2d 37: 22.36%
Sparsity in Conv2d 40: 25.59%
Sparsity in Conv2d 43: 21.91%
Sparsity in Conv2d 46: 30.15%
Sparsity in Conv2d 49: 33.14%
Sparsity in Conv2d 53: 36.91%
Sparsity in Conv2d 56: 54.49%
Sparsity in Conv2d 59: 26.49%
Sparsity in Conv2d 62: 62.55%
Sparsity in Conv2d 65: 68.04%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>Sparsifier._compute_threshold<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">zs</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">zs</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ps</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">large_final</span> <span class="n">weight</span> <span class="n">local</span><span class="p">:</span> <span class="mf">93.3</span>
<span class="n">upd</span> <span class="n">mag</span> <span class="n">increase</span> <span class="n">weight</span> <span class="n">local</span><span class="p">:</span> <span class="mf">88.3</span>
<span class="n">mag</span> <span class="n">increase</span> <span class="n">weight</span> <span class="n">local</span><span class="p">:</span> <span class="mf">87.3</span>
    
<span class="n">upd</span> <span class="n">mag</span> <span class="n">increase</span> <span class="n">weight</span> <span class="k">global</span><span class="p">:</span> 
<span class="n">mag</span> <span class="n">increase</span> <span class="n">weight</span> <span class="k">global</span><span class="p">:</span> <span class="mf">86.9</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">zs</span><span class="o">/</span><span class="n">ps</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.3000, device=&#39;cuda:0&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Last-version">Last version<a class="anchor-link" href="#Last-version"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Criteria</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">needs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">needs_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">needs_init</span> <span class="ow">and</span> <span class="n">needs_update</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;The init values will be overwritten by the updating ones.&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_old_weights&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_old_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="c1"># If the previous value of weights is not known, take the initial value</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">granularities</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_init</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_init_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> <span class="n">wi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Granularity&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span> <span class="c1"># Put the mask into a buffer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_f</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_init</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wi</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">output</span> <span class="o">=</span> <span class="n">wf</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span> <span class="k">if</span> <span class="n">min_value</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">w</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
        <span class="n">output</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">descale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
        
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">:</span> 
            <span class="n">m</span><span class="o">.</span><span class="n">_old_weights</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c1"># The current value becomes the old one for the next iteration</span>
            
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
                <span class="n">global_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all masks</span>
                <span class="n">global_scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="n">global_scores</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold locally</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span> <span class="c1"># We don&#39;t want to scale individual layers in global</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;global&#39;</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
                <span class="n">global_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all masks</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold locally</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>
    
    
    
    

    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;global&#39;</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">min_value</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">min_value</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Sparsifier</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">layer_type</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_weights</span><span class="p">()</span> <span class="c1"># Save the original weights</span>

    <span class="k">def</span> <span class="nf">prune_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">sparsity_list</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">==</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;A list of sparsities cannot be passed using: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sparsities</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">iter</span><span class="p">(</span><span class="n">sparsity_list</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span> 
                <span class="n">sp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sparsities</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prune_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">round_to</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_batchnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mods</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">prune_batchnorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">bn</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">bn</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
    <span class="k">def</span> <span class="nf">_apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="c1"># We want to prune the bias when pruning filters</span>
    
    <span class="k">def</span> <span class="nf">_reset_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="n">init_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">init_biases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">init_biases</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">batchnorm</span><span class="o">.</span><span class="n">_BatchNorm</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>              
                <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                    
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_weights</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_buffers</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_mask&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_mask&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_weights&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_weights&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;_init_biases&#39;</span><span class="p">):</span> <span class="k">del</span> <span class="n">m</span><span class="o">.</span><span class="n">_buffers</span><span class="p">[</span><span class="s2">&quot;_init_biases&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_compute_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">global_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all scores</span>
                <span class="n">global_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)])</span> <span class="c1"># Get all masks</span>
                <span class="n">global_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">global_scores</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">global_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">global_scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Compute the threshold globally (only once per model pruning)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">min_value</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span> <span class="c1"># min_value is computed only once per prune_model</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">scores</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">descale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_mask</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sparsity</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span> <span class="n">scores</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid Context&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rounded_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_to_prune</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">round_to</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_to_prune</span><span class="o">/</span><span class="n">round_to</span><span class="p">),</span> <span class="n">round_to</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">round_to</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_threshold</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">round_to</span><span class="p">:</span>
            <span class="n">n_to_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounded_sparsity</span><span class="p">(</span><span class="n">n_to_keep</span><span class="p">,</span> <span class="n">round_to</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Make sure we don&#39;t remove every weight of a given layer</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_type</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity in </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="mf">100.</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">nelement</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="up-to-here">up to here<a class="anchor-link" href="#up-to-here"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Surprisingly, our network that is composed of $50 \%$ of zeroes performs reasonnably well when compared to our plain and dense network.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/fasterai/sparsify_callback.html#SparsifyCallback"><code>SparsifyCallback</code></a> also accepts a list of sparsities, corresponding to each layer of <code>layer_type</code> to be pruned. Below, we show how to prune only the intermediate layers of ResNet-18.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sparsities</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sp_cb</span> <span class="o">=</span> <span class="n">SparsifyCallback</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="n">sparsities</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">updating_magnitude_increase</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">cos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">sp_cb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pruning of weight until a sparsity of [0, 0, 0, 0, 0, 0, 50, 50, 50, 50, 50, 50, 50, 50, 0, 0, 0, 0, 0, 0]%
Saving Weights at epoch 0
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.643622</td>
      <td>0.582141</td>
      <td>0.820027</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.465808</td>
      <td>0.429811</td>
      <td>0.833559</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.359432</td>
      <td>0.355955</td>
      <td>0.844384</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.266583</td>
      <td>0.257044</td>
      <td>0.896482</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.177783</td>
      <td>0.223190</td>
      <td>0.912720</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sparsity at the end of epoch 0: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.77, 4.77, 4.77, 4.77, 4.77, 4.77, 4.77, 4.77, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]%
Sparsity at the end of epoch 1: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 17.27, 17.27, 17.27, 17.27, 17.27, 17.27, 17.27, 17.27, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]%
Sparsity at the end of epoch 2: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 32.73, 32.73, 32.73, 32.73, 32.73, 32.73, 32.73, 32.73, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]%
Sparsity at the end of epoch 3: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 45.23, 45.23, 45.23, 45.23, 45.23, 45.23, 45.23, 45.23, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]%
Sparsity at the end of epoch 4: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]%
Final Sparsity: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]%
Sparsity in Conv2d 2: 0.00%
Sparsity in Conv2d 8: 0.00%
Sparsity in Conv2d 11: 0.00%
Sparsity in Conv2d 14: 0.00%
Sparsity in Conv2d 17: 0.00%
Sparsity in Conv2d 21: 0.00%
Sparsity in Conv2d 24: 50.00%
Sparsity in Conv2d 27: 50.00%
Sparsity in Conv2d 30: 50.00%
Sparsity in Conv2d 33: 50.00%
Sparsity in Conv2d 37: 50.00%
Sparsity in Conv2d 40: 50.00%
Sparsity in Conv2d 43: 50.00%
Sparsity in Conv2d 46: 50.00%
Sparsity in Conv2d 49: 0.00%
Sparsity in Conv2d 53: 0.00%
Sparsity in Conv2d 56: 0.00%
Sparsity in Conv2d 59: 0.00%
Sparsity in Conv2d 62: 0.00%
Sparsity in Conv2d 65: 0.00%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>On top of that, the <a href="/fasterai/sparsify_callback.html#SparsifyCallback"><code>SparsifyCallback</code></a>can also take many optionnal arguments:</p>
<ul>
<li><code>start_sparsity</code>: the sparsity that the schedule will use as a starting point (default to 0)</li>
<li><code>start_epoch</code>: the epoch at which the schedule will start pruning (default to 0)</li>
<li><code>end_epoch</code>: the epoch at which the schedule will stop pruning (default to the training epochs passed in <code>fit</code>)</li>
<li><code>lth</code>: whether training using the Lottery Ticket Hypothesis, i.e. reset the weights to their original value at each pruning step (more information in the Lottery Ticket Hypothesis section)</li>
<li><code>rewind_epoch</code>: the epoch used as a reference for the Lottery Ticket Hypothesis with Rewinding (default to 0)</li>
<li><code>reset_end</code>: whether you want to reset the weights to their original values after training (pruning masks are still applied)</li>
<li><code>save_tickets</code>: whether to save intermediate winning tickets.</li>
<li><code>model</code>: pass a model or a part of the model if you don't want to apply pruning on the whole model trained.</li>
<li><code>round_to</code>: if specified, the weights will be pruned to the closest multiple value of <code>round_to</code>.</li>
<li><code>layer_type</code>: specify the type of layer that you want to apply pruning to (default to nn.Conv2d)`</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, we correctly pruned the convolution layers of our model, but we could imagine pruning the Linear Layers of even only the BatchNorm ones !</p>

</div>
</div>
</div>
</div>
 

